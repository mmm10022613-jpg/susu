<script>
    lucide.createIcons();

    // ç”¢å“è³‡æ–™ (å·²æ›´æ–°ç‚º 36 é …å“é …)
    const products = [
        // 420g ç³»åˆ— (å–®ç½ï¼Œåœ˜è³¼åƒ¹ $300 æˆ– $360)
        { id: 101, name: "æ‹›ç‰Œé»ƒé‡‘æ³¡èœ420g", price: 300, tag: "äººæ°£ No.1", category: "non-spicy", image: "uploaded:image_66ce94.png-1bf48bdb-094e-4fce-90cf-bed572005124", desc: "é‡‘é»ƒè’œé¦™ï¼Œé…¸ç”œçˆ½è„†çš„ç¶“å…¸å£å‘³ã€‚" },
        { id: 102, name: "æ—¥å¼èƒ¡éº»æ³¡èœ420g", price: 300, tag: "æ¿ƒåšé¦™é†‡", category: "non-spicy", image: "uploaded:image_66ce5b.png-ffb83256-3d01-426f-86b3-0ee9280fc642", desc: "æ¿ƒéƒæ—¥å¼èƒ¡éº»é†¬æ±ï¼Œæ¸…çˆ½ä¸è†©ã€‚" },
        { id: 103, name: "éŸ“å¼æ³¡èœ420g", price: 300, tag: "è¾›è¾£éç™®", category: "spicy", image: "uploaded:image_66ce39.png-0d65146b-e2e3-4c09-b946-647ee920fc6c", desc: "æ­£å®—éŸ“å¼è¾£ç²‰é†ƒè£½ï¼Œé©åˆé‡å£å‘³æ„›å¥½è€…ã€‚" },
        { id: 104, name: "ç³–é†‹æ³¡èœ420g", price: 300, tag: "å¤æ—©å‘³", category: "non-spicy", image: "uploaded:image_667cbe.png-d8261501-cfac-402a-81eb-44ce21d8ac39", desc: "å‚³çµ±å°å¼é¢¨å‘³ï¼Œé…¸ç”œé–‹èƒƒã€‚" },
        { id: 105, name: "é»ƒé‡‘æµ·å¸¶çµ²420g", price: 300, tag: "æµ·æ´‹æ¸…çˆ½", category: "non-spicy", image: "uploaded:image_667cb7.png-2bd0b74f-b311-410e-928c-45edf8ff98a7", desc: "åš´é¸æ—¥æœ¬æ˜†å¸ƒï¼Œå£æ„Ÿè„†æ»‘è§£è†©ã€‚" },
        { id: 106, name: "é»ƒé‡‘æé®‘è‡420g", price: 300, tag: "Qå½ˆå¤šæ±", category: "non-spicy", image: "uploaded:image_667c9d.png-f7c2588a-e7b8-4a20-9a4e-01a5b4dd696e", desc: "å¤§å¡Šæé®‘è‡ï¼Œå¸é£½é»ƒé‡‘é†¬æ±ç²¾è¯ã€‚" },
        { id: 107, name: "æ³°å¼é…¸è¾£é³³çˆª420g", price: 360, tag: "å¾®è¾£é–‹èƒƒ", category: "meat", image: "uploaded:image_667c97.png-e76cfc1c-8db0-43be-af46-df2019cba76d", desc: "é…¸ã€è¾£ã€ç”œå®Œç¾å¹³è¡¡çš„æ³°å¼é¢¨å‘³é³³çˆªã€‚" },
        { id: 108, name: "é»ƒé‡‘é´¨æŒ420g", price: 360, tag: "åœ˜è³¼ç†±éŠ·", category: "meat", image: "uploaded:image_667c62.png-d11b20f2-ff50-4aa7-b7ad-80aa7f3205cd", desc: "è„†å£é´¨æŒæ­é…é»ƒé‡‘é†¬æ±ï¼Œå£æ„Ÿå±¤æ¬¡è±å¯Œã€‚" },
        
        // 420g æ–°å¢å“é … (å–®ç½ï¼Œåœ˜è³¼åƒ¹ $360)
        { id: 109, name: "æ³¡èœé»ƒç“œ420g", price: 360, tag: "å­£ç¯€é™å®š", category: "non-spicy", image: "https://placehold.co/400x300/fcd34d/57534e?text=æ³¡èœé»ƒç“œ", desc: "æ–°é®®å°é»ƒç“œæ­é…æ¸…çˆ½æ³¡èœæ±ï¼Œæ¸…è„†å¯å£ã€‚" },
        { id: 110, name: "é»ƒé‡‘ç‰ç±³ç­420g", price: 360, tag: "è”¬é£Ÿé¦–é¸", category: "non-spicy", image: "https://placehold.co/400x300/fcd34d/57534e?text=é»ƒé‡‘ç‰ç±³ç­", desc: "åš´é¸é®®å«©ç‰ç±³ç­ï¼Œé¦™ç”œå¤šæ±ï¼Œç´ é£Ÿå¯é£Ÿã€‚" },
        { id: 111, name: "å‚¬æ·šæ³¡èœ420g", price: 360, tag: "ç‰¹ç´šè¾£å‘³", category: "spicy", image: "https://placehold.co/400x300/ef4444/ffffff?text=å‚¬æ·šæ³¡èœ", desc: "æŒ‘æˆ°å‘³è•¾çš„æ¥µé™è¾£åº¦ï¼Œå¾Œå‹åè¶³ã€‚" },
        { id: 112, name: "è˜¿å¤§æŸš420g", price: 360, tag: "ç¨å®¶é¢¨å‘³", category: "non-spicy", image: "https://placehold.co/400x300/a8a29e/ffffff?text=è˜¿å¤§æŸš", desc: "ç™½è˜¿è””èˆ‡æŸšå­æ¸…é¦™çµåˆï¼Œè§£è†©é–‹èƒƒã€‚" },
        
        // 650g ç³»åˆ— (å–®ç½ï¼Œåœ˜è³¼åƒ¹ $360)
        { id: 113, name: "æ‹›ç‰Œé»ƒé‡‘æ³¡èœ650g", price: 360, tag: "ä»½é‡å‡ç´š", category: "non-spicy", image: "uploaded:image_66ce94.png-1bf48bdb-094e-4fce-90cf-bed572005124", desc: "å®¶åº­è™Ÿå¤§å®¹é‡ï¼Œç¶“å…¸é»ƒé‡‘è’œé¦™ã€‚" },
        { id: 114, name: "æ—¥å¼èƒ¡éº»æ³¡èœ650g", price: 360, tag: "ä»½é‡å‡ç´š", category: "non-spicy", image: "uploaded:image_66ce5b.png-ffb83256-3d01-426f-86b3-0ee9280fc642", desc: "å®¶åº­è™Ÿå¤§å®¹é‡ï¼Œæ¿ƒéƒæ—¥å¼èƒ¡éº»é¢¨å‘³ã€‚" },
        { id: 115, name: "éŸ“å¼æ³¡èœ650g", price: 360, tag: "ä»½é‡å‡ç´š", category: "spicy", image: "uploaded:image_66ce39.png-0d65146b-e2e3-4c09-b946-647ee920fc6c", desc: "å®¶åº­è™Ÿå¤§å®¹é‡ï¼Œæ­£å®—éŸ“å¼è¾£å‘³ã€‚" },
        { id: 116, name: "ç³–é†‹æ³¡èœ650g", price: 360, tag: "ä»½é‡å‡ç´š", category: "non-spicy", image: "uploaded:image_667cbe.png-d8261501-cfac-402a-81eb-44ce21d8ac39", desc: "å®¶åº­è™Ÿå¤§å®¹é‡ï¼Œå‚³çµ±å°å¼é…¸ç”œã€‚" },
        { id: 117, name: "é»ƒé‡‘æµ·å¸¶çµ²650g", price: 360, tag: "ä»½é‡å‡ç´š", category: "non-spicy", image: "uploaded:image_667cb7.png-2bd0b74f-b311-410e-928c-45edf8ff98a7", desc: "å®¶åº­è™Ÿå¤§å®¹é‡ï¼Œæ»‘è„†è§£è†©æµ·å¸¶çµ²ã€‚" },
        { id: 118, name: "é»ƒé‡‘æé®‘è‡650g", price: 360, tag: "ä»½é‡å‡ç´š", category: "non-spicy", image: "uploaded:image_667c9d.png-f7c2588a-e7b8-4a20-9a4e-01a5b4dd696e", desc: "å®¶åº­è™Ÿå¤§å®¹é‡ï¼ŒQå½ˆå¤šæ±æé®‘è‡ã€‚" },

        // é†¬æ–™/è‚‰å“ (å–®ç½ï¼Œåœ˜è³¼åƒ¹ $450 æˆ– $480)
        { id: 119, name: "å‚¬æ·šçš®è›‹è¾£æ¤’350g", price: 450, tag: "æ‹Œé£¯ç¥é†¬", category: "spicy", image: "https://placehold.co/400x300/ef4444/ffffff?text=çš®è›‹è¾£æ¤’", desc: "é¦™è¾£ä¸‹é£¯çš„ç¨ç‰¹è¾£æ¤’é†¬ï¼Œå…§å«çš®è›‹ï¼Œè¾£åº¦çˆ†è¡¨ã€‚" },
        { id: 120, name: "å‚¬æ·šè’œé¦™çš®è›‹350g", price: 450, tag: "è’œå‘³æ˜‡è¯", category: "spicy", image: "https://placehold.co/400x300/ef4444/ffffff?text=è’œé¦™çš®è›‹", desc: "æ¿ƒéƒè’œé¦™æ­é…çš®è›‹ï¼Œå±¤æ¬¡è±å¯Œçš„è¾£é†¬ï¼Œé¦™æ°£è¿·äººã€‚" },
        { id: 121, name: "å·å¿ƒæµ·èœ‡420g", price: 450, tag: "é ‚ç´šæ¶¼æ‹Œ", category: "meat", image: "https://placehold.co/400x300/fbbf24/57534e?text=å·å¿ƒæµ·èœ‡", desc: "çˆ½è„†æµ·èœ‡çµ²ï¼Œä½ä»¥ç§˜è£½é†¬æ±ï¼Œå£æ„Ÿçµ•ä½³ã€‚" },
        { id: 122, name: "é–‹ç‡»è’œè‹—é´¨(300g)", price: 480, tag: "å®´å®¢èœ", category: "meat", image: "https://placehold.co/400x300/fbbf24/57534e?text=è’œè‹—é´¨", desc: "ç…™ç‡»é´¨è‚‰æ­é…è’œè‹—ï¼Œé¢¨å‘³ç¨ç‰¹ï¼Œå³é£Ÿç¾å‘³ã€‚" },

        // å‘¨é‚Šå•†å“
        { id: 123, name: "å”ç™¼è¡Œæ³¡èœç¦®ç›’", price: 99, tag: "é€ç¦®é¦–é¸", category: "accessory", image: "https://placehold.co/400x300/d4d4d8/57534e?text=æ³¡èœç¦®ç›’", desc: "ç²¾ç¾åŒ…è£ç¦®ç›’ï¼Œé€ç¦®å¤§æ–¹é«”é¢ï¼Œä¸å«æ³¡èœã€‚" },
        { id: 124, name: "è Ÿç­†å°æ–°è¯åä¿å†·è¢‹[æ‘©å¡æ£•]", price: 599, tag: "é™é‡è¯å", category: "accessory", image: "https://placehold.co/400x300/e9d5ff/57534e?text=è¯åä¿å†·è¢‹", desc: "å¯æ„›å°æ–°åœ–æ¡ˆï¼Œæ‘©å¡æ£•ï¼Œä¿å†·æ•ˆæœä½³ã€‚" },
        { id: 125, name: "è Ÿç­†å°æ–°è¯åä¿å†·è¢‹[è»ç¶ ]", price: 599, tag: "é™é‡è¯å", category: "accessory", image: "https://placehold.co/400x300/e9d5ff/57534e?text=è¯åä¿å†·è¢‹", desc: "å¯æ„›å°æ–°åœ–æ¡ˆï¼Œè»ç¶ è‰²ï¼Œä¿å†·æ•ˆæœä½³ã€‚" },

        // çµ„åˆå„ªæƒ  (Bundle)
        { id: 126, name: "ã€11æ¨‚ç¿»å¤©ã€‘é»ƒé‡‘æ³¡èœ650g*3", price: 900, tag: "è¶…å€¼çµ„åˆ", category: "bundle", image: "https://placehold.co/400x300/10b981/ffffff?text=é»ƒé‡‘æ³¡èœçµ„åˆ", desc: "æ‹›ç‰Œé»ƒé‡‘æ³¡èœ 650g x 3ç½ï¼Œåœ˜è³¼ä¸»æ¨ï¼ŒåŸåƒ¹ $1260ã€‚" },
        { id: 127, name: "ã€11æ¨‚ç¿»å¤©ã€‘éŸ“å¼æ³¡èœ650g*3", price: 900, tag: "è¶…å€¼çµ„åˆ", category: "bundle", image: "https://placehold.co/400x300/10b981/ffffff?text=éŸ“å¼æ³¡èœçµ„åˆ", desc: "éŸ“å¼æ³¡èœ 650g x 3ç½ï¼Œè¶…å€¼å„ªæƒ ï¼ŒåŸåƒ¹ $1260ã€‚" },
        { id: 128, name: "ã€11æ¨‚ç¿»å¤©ã€‘é»ƒé‡‘æµ·å¸¶çµ²650g*3", price: 900, tag: "è¶…å€¼çµ„åˆ", category: "bundle", image: "https://placehold.co/400x300/10b981/ffffff?text=æµ·å¸¶çµ²çµ„åˆ", desc: "é»ƒé‡‘æµ·å¸¶çµ² 650g x 3ç½ï¼Œæ¸…çˆ½ä¸è¾£çµ„åˆï¼ŒåŸåƒ¹ $1260ã€‚" },
        { id: 129, name: "ã€11æ¨‚ç¿»å¤©ã€‘é»ƒé‡‘æé®‘è‡650g*3", price: 900, tag: "è¶…å€¼çµ„åˆ", category: "bundle", image: "https://placehold.co/400x300/10b981/ffffff?text=æé®‘è‡çµ„åˆ", desc: "é»ƒé‡‘æé®‘è‡ 650g x 3ç½ï¼ŒQå½ˆç¾å‘³çµ„åˆï¼ŒåŸåƒ¹ $1260ã€‚" },
        { id: 130, name: "ã€11æ¨‚ç¿»å¤©ã€‘èƒ¡éº»æ³¡èœ650g*3", price: 900, tag: "è¶…å€¼çµ„åˆ", category: "bundle", image: "https://placehold.co/400x300/10b981/ffffff?text=èƒ¡éº»æ³¡èœçµ„åˆ", desc: "æ—¥å¼èƒ¡éº»æ³¡èœ 650g x 3ç½ï¼Œè¶…å€¼å„ªæƒ ï¼ŒåŸåƒ¹ $1260ã€‚" },
        { id: 131, name: "ã€11æ¨‚ç¿»å¤©ã€‘é»ƒé‡‘é´¨æŒ420g*3", price: 900, tag: "è¶…å€¼çµ„åˆ", category: "bundle", image: "https://placehold.co/400x300/10b981/ffffff?text=é»ƒé‡‘é´¨æŒçµ„åˆ", desc: "é»ƒé‡‘é´¨æŒ 420g x 3ç½ï¼Œè‚‰å“ç‰¹æƒ çµ„åˆï¼ŒåŸåƒ¹ $1080ã€‚" },
        { id: 132, name: "ã€11æ¨‚ç¿»å¤©ã€‘æ³¡èœé»ƒç“œ420g*3", price: 900, tag: "è¶…å€¼çµ„åˆ", category: "bundle", image: "https://placehold.co/400x300/10b981/ffffff?text=æ³¡èœé»ƒç“œçµ„åˆ", desc: "æ³¡èœé»ƒç“œ 420g x 3ç½ï¼Œæ¸…è„†çˆ½å£çµ„åˆï¼ŒåŸåƒ¹ $1080ã€‚" },
        { id: 133, name: "ã€11æ¨‚ç¿»å¤©ã€‘å‰æ¤’å‚¬æ·šæ³¡èœ420g*3", price: 900, tag: "è¶…å€¼çµ„åˆ", category: "bundle", image: "https://placehold.co/400x300/10b981/ffffff?text=å‰æ¤’å‚¬æ·šçµ„åˆ", desc: "å‰æ¤’å‚¬æ·šæ³¡èœ 420g x 3ç½ï¼Œéº»è¾£çµ„åˆï¼ŒåŸåƒ¹ $1080ã€‚" },
        { id: 134, name: "ã€11æ¨‚ç¿»å¤©ã€‘å·å¿ƒæµ·èœ‡420g*3", price: 1350, tag: "è¶…å€¼çµ„åˆ", category: "bundle", image: "https://placehold.co/400x300/10b981/ffffff?text=å·å¿ƒæµ·èœ‡çµ„åˆ", desc: "å·å¿ƒæµ·èœ‡ 420g x 3ç½ï¼Œè±ªè¯æµ·å‘³çµ„åˆï¼ŒåŸåƒ¹ $1800ã€‚" },
        { id: 135, name: "ã€11æ¨‚ç¿»å¤©ã€‘å‚¬æ·šè’œé¦™çš®è›‹350g*4", price: 1800, tag: "è¶…å€¼çµ„åˆ", category: "bundle", image: "https://placehold.co/400x300/10b981/ffffff?text=è’œé¦™çš®è›‹çµ„åˆ", desc: "å‚¬æ·šè’œé¦™çš®è›‹ 350g x 4ç½ï¼Œé†¬æ–™ç‰¹æƒ çµ„åˆï¼ŒåŸåƒ¹ $2200ã€‚" },
        
        // å·²æ›´æ–°å“é …: é–‹ç‡»è’œè‹—é´¨(300g)*3 çµ„åˆ (ID: 136)
        { id: 136, name: "ã€è¶…å€¼çµ„åˆã€‘é–‹ç‡»è’œè‹—é´¨(300g)*3", price: 1440, tag: "è‚‰å“çµ„åˆ", category: "bundle", image: "https://placehold.co/400x300/fbbf24/57534e?text=è’œè‹—é´¨+çµ„åˆ", desc: "é–‹ç‡»è’œè‹—é´¨ 300g x 3ä»½ï¼Œä»½é‡å……è¶³ï¼Œæ»¿è¶³å…¨å®¶éœ€æ±‚ï¼ŒåŸåƒ¹ $1440ã€‚" }
    ];

    // è³¼ç‰©è»Šè³‡æ–™çµæ§‹ï¼š { productId, userName, qty, timestamp }
    let cart = [];
    
    // å…¨åŸŸç‹€æ…‹ï¼šåœ˜ä¸»æ¨¡å¼
    let isGroupLeader = false;
    
    // å¯†ç¢¼è¨­å®š
    const LEADER_PASSWORD = '1104'; 

    // è³¼ç‰©è»Šè³‡æ–™åœ¨ localStorage å…§çš„ Key
    const CART_STORAGE_KEY = 'xie-fa-xing-cart';
    const BUYER_NAME_KEY = 'xie-fa-xing-buyer-name';
    const IS_LEADER_KEY = 'xie-fa-xing-is-leader';

    // è¼‰å…¥ localStorage å„²å­˜çš„è³‡æ–™
    function loadData() {
        // è¼‰å…¥è³¼ç‰©è»Š
        const savedCart = localStorage.getItem(CART_STORAGE_KEY);
        if (savedCart) {
            try {
                const loadedCart = JSON.parse(savedCart);
                // ç¯©é¸æ‰èˆŠçš„æˆ–ä¸å­˜åœ¨çš„å•†å“ï¼Œé˜²æ­¢éŒ¯èª¤
                cart = loadedCart.filter(item => products.some(p => p.id === item.productId));
            } catch (e) {
                console.error("Failed to parse cart data from localStorage", e);
                cart = [];
            }
        }

        // è¼‰å…¥è¨‚è³¼äººåç¨±
        const buyerInput = document.getElementById('current-buyer-input');
        const savedName = localStorage.getItem(BUYER_NAME_KEY);
        if (savedName) {
            buyerInput.value = savedName;
        } else {
            saveBuyerName(buyerInput.value); // å„²å­˜é è¨­å€¼
        }
        
        // è¼‰å…¥åœ˜ä¸»æ¨¡å¼ç‹€æ…‹
        const savedLeaderMode = localStorage.getItem(IS_LEADER_KEY);
        isGroupLeader = savedLeaderMode === 'true';
        updateLeaderToggleUI();
    }

    // å„²å­˜è³¼ç‰©è»Šåˆ° localStorage
    function saveCart() {
        localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cart));
    }

    // å„²å­˜è¨‚è³¼äººåç¨±åˆ° localStorage
    function saveBuyerName(name) {
        const trimmedName = name.trim() || "æœªå…·å";
        localStorage.setItem(BUYER_NAME_KEY, trimmedName);
        // åŒæ­¥æ›´æ–° input æ¡†çš„å€¼ï¼Œä»¥é˜²ä½¿ç”¨è€…è¼¸å…¥ç©ºæ ¼
        document.getElementById('current-buyer-input').value = trimmedName;
        updateCartUI(); // åç¨±æ”¹è®Šå¾Œï¼Œæ›´æ–° UI (åœ˜å“¡æ¨¡å¼æœƒç”¨åˆ°)
        updateStatsUI();
    }
    
    // åœ˜ä¸»æ¨¡å¼åˆ‡æ›é‚è¼¯ (æ–°å¢å¯†ç¢¼é©—è­‰)
    function toggleLeaderMode(isChecked) {
        const toggleEl = document.getElementById('leader-mode-toggle');

        if (isChecked) {
            // å˜—è©¦é€²å…¥åœ˜ä¸»æ¨¡å¼ï¼Œéœ€è¦å¯†ç¢¼
            showCustomModal(
                "é€²å…¥åœ˜ä¸»æ¨¡å¼",
                "æ­¤æ¨¡å¼å°‡é¡¯ç¤ºæ‰€æœ‰åœ˜å“¡è¨‚å–®æ˜ç´°åŠåˆ†å¸³è³‡è¨Šã€‚è«‹è¼¸å…¥åœ˜ä¸»å¯†ç¢¼ã€‚",
                true, // isConfirm: Yes, it's a confirmation/input dialog
                (password) => { // onConfirm callback receives the input value
                    if (password === LEADER_PASSWORD) {
                        // å¯†ç¢¼æ­£ç¢º
                        isGroupLeader = true;
                        localStorage.setItem(IS_LEADER_KEY, 'true');
                        showToast("åœ˜ä¸»æ¨¡å¼å·²é–‹å•Ÿ", "å¯ä»¥æŸ¥çœ‹æ‰€æœ‰è¨‚å–®");
                    } else {
                        // å¯†ç¢¼éŒ¯èª¤æˆ–å–æ¶ˆï¼Œé˜»æ­¢åˆ‡æ›ï¼Œä¸¦å½ˆå‡ºéŒ¯èª¤æç¤º
                        toggleEl.checked = false; // Reset the toggle switch in UI
                        localStorage.setItem(IS_LEADER_KEY, 'false');
                        // ä½¿ç”¨ showCustomModal é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                        showCustomModal("å¯†ç¢¼éŒ¯èª¤", "æ‚¨è¼¸å…¥çš„å¯†ç¢¼ä¸æ­£ç¢ºã€‚ç„¡æ³•é€²å…¥åœ˜ä¸»æ¨¡å¼ã€‚", false);
                    }
                    updateLeaderToggleUI(); // ç¸½æ˜¯æ›´æ–° UI ç‹€æ…‹
                    updateCartUI();
                    updateStatsUI();
                },
                true, // showInput: Show password input
                'password', // inputType: Use password field
                'å¯†ç¢¼ ():' // inputLabel: Label for the input
            );

        } else {
            // é€€å‡ºåœ˜ä¸»æ¨¡å¼ï¼Œä¸éœ€è¦å¯†ç¢¼
            isGroupLeader = false;
            localStorage.setItem(IS_LEADER_KEY, 'false');
            updateLeaderToggleUI();
            updateCartUI();
            updateStatsUI();
            showToast("åœ˜ä¸»æ¨¡å¼å·²é—œé–‰", "å·²åˆ‡æ›ç‚ºåœ˜å“¡éš±ç§æ¨¡å¼");
        }
    }

    // æ›´æ–°åœ˜ä¸»æ¨¡å¼ UI é¡¯ç¤º (è² è²¬è¨­å®šå‹¾é¸ç‹€æ…‹å’Œé¡è‰²)
    function updateLeaderToggleUI() {
        const toggle = document.getElementById('leader-mode-toggle');
        const slider = document.getElementById('leader-toggle-slider');
        
        if (toggle) toggle.checked = isGroupLeader; // ç¢ºä¿ checkbox ç‹€æ…‹èˆ‡ isGroupLeader ä¸€è‡´
        
        if (slider) {
            if (isGroupLeader) {
                slider.parentElement.classList.add('bg-red-500');
                slider.parentElement.classList.remove('bg-stone-300');
                slider.style.transform = 'translateX(1rem)';
            } else {
                slider.parentElement.classList.remove('bg-red-500');
                slider.parentElement.classList.add('bg-stone-300');
                slider.style.transform = 'translateX(0)';
            }
        }
    }

    // é¡¯ç¤ºè‡ªå®šç¾©æ¨¡æ…‹è¦–çª— (å–ä»£ alert/confirm) - æ–°å¢ showInput/inputType/inputLabel åƒæ•¸
    function showCustomModal(title, message, isConfirm = false, onConfirm = null, showInput = false, inputType = 'text', inputLabel = 'è¼¸å…¥å…§å®¹') {
        const container = document.getElementById('custom-modal-container');
        const content = document.getElementById('custom-modal-content');
        const titleEl = document.getElementById('modal-title');
        const messageEl = document.getElementById('modal-message');
        const confirmBtn = document.getElementById('modal-confirm-btn');
        const cancelBtn = document.getElementById('modal-cancel-btn');
        const inputGroup = document.getElementById('modal-input-group');
        const inputEl = document.getElementById('modal-input');
        const inputLabelEl = document.getElementById('modal-input-label');
        const modalFooter = document.getElementById('modal-footer'); // æ–°å¢å–å¾— footer

        // è¨­ç½®å…§å®¹
        titleEl.innerText = title;
        messageEl.innerText = message;
        
        // è™•ç†è¼¸å…¥æ¬„ä½
        if (showInput) {
            inputGroup.classList.remove('hidden');
            inputEl.type = inputType;
            inputLabelEl.innerText = inputLabel;
            inputEl.value = ''; // æ¸…ç©ºä¸Šæ¬¡çš„å€¼
            
            // è™•ç† Enter éµæäº¤
            inputEl.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    confirmBtn.click();
                }
            };
            // è®“è¼¸å…¥æ¡†è‡ªå‹•ç²å¾—ç„¦é»
            setTimeout(() => inputEl.focus(), 350);
        } else {
            inputGroup.classList.add('hidden');
            inputEl.onkeypress = null;
        }

        // ç¢ºèª/æç¤ºæ¨¡å¼åˆ‡æ›
        if (isConfirm || showInput) {
            cancelBtn.classList.remove('hidden');
            confirmBtn.innerText = showInput ? 'ç¢ºèª' : 'ç¢ºèªé€å‡º';
            confirmBtn.className = 'px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition-colors';
        } else {
            cancelBtn.classList.add('hidden');
            confirmBtn.innerText = 'é—œé–‰';
            confirmBtn.className = 'px-4 py-2 bg-stone-800 hover:bg-stone-900 text-white font-medium rounded-lg transition-colors';
        }

        // é‡ç½® modal-footer å…§å®¹ (é‡è¦! é¿å…ä¹‹å‰ add çš„å…§å®¹æ®˜ç•™)
        modalFooter.innerHTML = '';
        modalFooter.appendChild(cancelBtn);
        modalFooter.appendChild(confirmBtn);

        // è¨­ç½®æŒ‰éˆ•äº‹ä»¶
        confirmBtn.onclick = () => {
            const result = showInput ? inputEl.value : null; // å–å¾—è¼¸å…¥å€¼
            hideCustomModal();
            if (onConfirm) {
                onConfirm(result); // å‚³å…¥è¼¸å…¥å€¼
            }
        };

        cancelBtn.onclick = () => {
             // å¦‚æœæ˜¯å¯†ç¢¼è¼¸å…¥æ¨¡å¼ï¼Œå–æ¶ˆæ™‚ä¹Ÿéœ€è¦è™•ç†ï¼Œä¸¦ä¸”ç¢ºä¿ toggle ç‹€æ…‹è¢«é‡ç½®
            if (showInput) {
                const toggleEl = document.getElementById('leader-mode-toggle');
                if (toggleEl && toggleEl.checked) {
                    toggleEl.checked = false;
                    updateLeaderToggleUI();
                }
            }
            hideCustomModal();
        };

        // é¡¯ç¤º
        container.classList.remove('hidden');
        container.style.display = 'flex';
        setTimeout(() => {
            content.classList.remove('scale-90', 'opacity-0');
        }, 10);
        
        // æ–°å¢: é‡ç½® Modal å¯¬åº¦ (è§£æ±ºé€å‡ºè¨‚å–®å ±è¡¨é¡¯ç¤ºå¤ªå°çš„å•é¡Œ)
        content.classList.remove('max-w-md'); // ç§»é™¤é è¨­å¯¬åº¦
    }
    
    // éš±è—è‡ªå®šç¾©æ¨¡æ…‹è¦–çª—
    function hideCustomModal() {
        const container = document.getElementById('custom-modal-container');
        const content = document.getElementById('custom-modal-content');
        content.classList.add('scale-90', 'opacity-0');
        setTimeout(() => {
            container.classList.add('hidden');
            container.style.display = 'none';
        }, 300);
        // æ–°å¢: æ¢å¾© Modal é è¨­å¯¬åº¦
        content.classList.add('max-w-md'); 
    }
    
    // é¡¯ç¤º Toast é€šçŸ¥ (é€šç”¨ç‰ˆæœ¬)
    let toastTimeout;
    function showToast(mainText, subText) {
        const toast = document.getElementById('toast');
        document.getElementById('toast-message').innerText = mainText;
        document.getElementById('toast-sub').innerText = subText;

        // æ¸…é™¤ä¹‹å‰çš„ timeoutï¼Œé˜²æ­¢é‡è¤‡å½ˆå‡º
        clearTimeout(toastTimeout);
        
        // é¡¯ç¤º Toast
        toast.classList.remove('translate-y-20', 'opacity-0');
        
        // è¨­ç½®è‡ªå‹•éš±è—
        toastTimeout = setTimeout(() => {
            toast.classList.add('translate-y-20', 'opacity-0');
        }, 3000);
    }

    // åŠ å…¥è³¼ç‰©è»Š
    function addToCart(productId) {
        const product = products.find(p => p.id === productId);
        // å¾ input æ¬„ä½å–å¾—ç•¶å‰è¨‚è³¼äººåç¨±
        const buyerInput = document.getElementById('current-buyer-input');
        const buyerName = buyerInput.value.trim() || "æœªå…·å"; 
        
        // ç²å–é¸æ“‡çš„æ•¸é‡
        const qtySelect = document.getElementById(`qty-${productId}`);
        const selectedQty = parseInt(qtySelect.value);

        // æª¢æŸ¥è³¼ç‰©è»Šä¸­æ˜¯å¦å·²ç¶“æœ‰ "é€™å€‹äºº" è²· "é€™é …å•†å“"
        const existingItem = cart.find(item => item.productId === productId && item.userName === buyerName);

        if (existingItem) {
            existingItem.qty += selectedQty;
        } else {
            cart.push({
                productId: product.id,
                productName: product.name,
                price: product.price,
                image: product.image,
                userName: buyerName,
                qty: selectedQty,
                timestamp: Date.now() // ç”¨æ–¼æ’åº
            });
        }
        
        // é‡ç½®æ•¸é‡é¸å–®å› 1
        qtySelect.value = 1;

        saveCart(); // å„²å­˜è®Šå‹•
        updateCartUI();
        updateStatsUI();
        
        // é¡¯ç¤º Toast
        // ç§»é™¤åç¨±ä¸­çš„å®¹é‡è³‡è¨Š (420g, 650g, 350g, 300g) å’Œçµ„è£è³‡è¨Š (*3, *4)
        const cleanName = product.name
            .replace(/(\d+g)|(\(\d+g\))|(\*\d)/g, '')
            .replace('ã€11æ¨‚ç¿»å¤©ã€‘', '')
            .replace('ã€è¶…å€¼çµ„åˆã€‘', '')
            .trim();
        showToast(`å·²åŠ å…¥ ${selectedQty} ä»½åˆ°è³¼ç‰©è»Š`, `å¹« ${buyerName} é»äº† ${cleanName}`);
        
        if (navigator.vibrate) navigator.vibrate(50);
    }

    // ç§»é™¤/ä¿®æ”¹æ•¸é‡
    function changeQty(productId, userName, delta) {
        const itemIndex = cart.findIndex(item => item.productId === productId && item.userName === userName);
        if (itemIndex > -1) {
            // åœ¨åœ˜å“¡æ¨¡å¼ä¸‹ï¼Œåªèƒ½ä¿®æ”¹è‡ªå·±çš„è¨‚å–®
            if (!isGroupLeader && cart[itemIndex].userName !== getCurrentBuyerName()) {
                showCustomModal("æ¬Šé™ä¸è¶³", "æ‚¨ç›®å‰åœ¨åœ˜å“¡æ¨¡å¼ï¼Œåªèƒ½ç·¨è¼¯è‡ªå·±çš„è¨‚å–®ã€‚", false);
                return;
            }

            cart[itemIndex].qty += delta;
            if (cart[itemIndex].qty <= 0) {
                cart.splice(itemIndex, 1);
            }
            saveCart(); // å„²å­˜è®Šå‹•
            updateCartUI();
            updateStatsUI();
        }
    }

    function removeItem(productId, userName) {
         // åœ¨åœ˜å“¡æ¨¡å¼ä¸‹ï¼Œåªèƒ½åˆªé™¤è‡ªå·±çš„è¨‚å–®
        if (!isGroupLeader && userName !== getCurrentBuyerName()) {
            showCustomModal("æ¬Šé™ä¸è¶³", "æ‚¨ç›®å‰åœ¨åœ˜å“¡æ¨¡å¼ï¼Œåªèƒ½åˆªé™¤è‡ªå·±çš„è¨‚å–®ã€‚", false);
            return;
        }
        
        cart = cart.filter(item => !(item.productId === productId && item.userName === userName));
        saveCart(); // å„²å­˜è®Šå‹•
        updateCartUI();
        updateStatsUI();
    }

    function clearCart() {
        // åœ¨åœ˜å“¡æ¨¡å¼ä¸‹ï¼Œåªèƒ½æ¸…ç©ºè‡ªå·±çš„è¨‚å–®
        if (!isGroupLeader) {
             showCustomModal("æ¬Šé™ä¸è¶³", "æ‚¨ç›®å‰åœ¨åœ˜å“¡æ¨¡å¼ï¼Œåªèƒ½æ¸…ç©ºè‡ªå·±çš„è¨‚å–®ã€‚", false);
             return;
        }

        // ä½¿ç”¨è‡ªå®šç¾© Modal é€²è¡Œç¢ºèª
        showCustomModal("ç¢ºèªæ¸…ç©º", "æ‚¨ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å·²åŠ å…¥è³¼ç‰©è»Šçš„å“é …å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚", true, () => {
            cart = [];
            saveCart(); // å„²å­˜è®Šå‹•
            updateCartUI();
            updateStatsUI();
            showToast("è³¼ç‰©è»Šå·²æ¸…ç©º", "æ‰€æœ‰è¨‚å–®è³‡æ–™å·²ç§»é™¤");
        });
    }
    
    // å–å¾—ç›®å‰è¨‚è³¼äººåç¨±
    function getCurrentBuyerName() {
        const buyerInput = document.getElementById('current-buyer-input');
        return buyerInput ? buyerInput.value.trim() : "æœªå…·å";
    }
    
    // ****** æ–°å¢åŠŸèƒ½ï¼šè¤‡è£½å ±è¡¨æ–‡å­—åˆ°å‰ªè²¼ç°¿ ******
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            showToast("è¤‡è£½æˆåŠŸï¼", "å ±è¡¨å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿");
            clearOrderData();
        }).catch(err => {
            console.error('ç„¡æ³•è¤‡è£½åˆ°å‰ªè²¼ç°¿', err);
            showCustomModal("è¤‡è£½å¤±æ•—", "æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´è‡ªå‹•è¤‡è£½ï¼Œè«‹æ‰‹å‹•è¤‡è£½ä¸Šæ–¹å ±è¡¨æ–‡å­—ã€‚", false);
        });
    }
    
    // ****** æ–°å¢åŠŸèƒ½ï¼šå°‡å ±è¡¨æ–‡å­—å‚³é€åˆ° Line ******
    function sendToLine(text) {
        // Line çš„åˆ†äº« URL æ ¼å¼
        const lineText = encodeURIComponent(text);
        const lineUrl = `https://line.me/R/share?text=${lineText}`;
        window.open(lineUrl, '_blank');
        showToast("å·²é–‹å•Ÿ Line æ‡‰ç”¨ç¨‹å¼", "è«‹é¸æ“‡å°è±¡å‚³é€å ±è¡¨");
        clearOrderData();
    }
    
    // ****** æ–°å¢åŠŸèƒ½ï¼šæ¸…ç©ºè¨‚å–®è³‡æ–™ (è¤‡è£½/å‚³é€å¾ŒåŸ·è¡Œ) ******
    function clearOrderData() {
        cart = [];
        saveCart(); // å„²å­˜è®Šå‹•
        updateCartUI();
        updateStatsUI();
        toggleCart(); // é—œé–‰å´é‚Šæ¬„
    }

    // æäº¤è¨‚å–® (ç”¢ç”Ÿå ±è¡¨ä¸¦æ¸…ç©º) - **é‚è¼¯å·²ä¿®æ”¹**
    function submitOrder() {
        if (cart.length === 0) {
            showCustomModal("æç¤º", "è³¼ç‰©è»Šæ˜¯ç©ºçš„å–”ï¼è«‹å…ˆåŠ å…¥å•†å“ã€‚", false);
            return;
        }
        
        // åœ˜å“¡æ¨¡å¼ä¸‹é˜»æ­¢æäº¤ç¸½è¨‚å–®
        if (!isGroupLeader) {
            showCustomModal("æ¬Šé™ä¸è¶³", "æ‚¨ç›®å‰åœ¨åœ˜å“¡æ¨¡å¼ã€‚åªæœ‰åœ˜ä¸»æ‰èƒ½æäº¤ç¸½è¨‚å–®ä¸¦æ¸…ç©ºå…¨éƒ¨è³‡æ–™ã€‚", false);
            return;
        }
        
        // çµ±è¨ˆè³‡æ–™
        const userStats = {};
        let grandTotal = 0;
        
        // 1. æ•´ç†æ¯ä½è¨‚è³¼äººçš„æ˜ç´°å’Œç¸½é‡‘é¡
        cart.forEach(item => {
            if (!userStats[item.userName]) {
                userStats[item.userName] = {
                    items: [],
                    total: 0
                };
            }
            
            // ç§»é™¤åç¨±ä¸­çš„å®¹é‡è³‡è¨Š (420g, 650g, 350g, 300g) å’Œçµ„è£è³‡è¨Š (*3, *4)
            const displayName = item.productName
                .replace(/(\d+g)|(\(\d+g\))|(\*\d)/g, '')
                .replace('ã€11æ¨‚ç¿»å¤©ã€‘', '')
                .replace('ã€è¶…å€¼çµ„åˆã€‘', '')
                .trim();
            
            const itemPrice = item.price;
            const itemTotal = item.price * item.qty;

            // å ±è¡¨è¡Œï¼šå“å xæ•¸é‡ (å–®åƒ¹) = ç¸½åƒ¹
            userStats[item.userName].items.push(`- ${displayName} x${item.qty} (NT$ ${itemPrice}) = NT$ ${itemTotal}`);
            userStats[item.userName].total += itemTotal;
            grandTotal += itemTotal;
        });

        // 2. ç”Ÿæˆå ±è¡¨æ–‡å­—
        let report = "ã€å”ç™¼è¡Œæ³¡èœ - åœ˜è³¼è¨‚å–®çµ±è¨ˆã€‘\n";
        report += `çµ±è¨ˆæ™‚é–“ï¼š${new Date().toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })}\n`;
        report += "---------------------------------\n\n";
        
        // 3. åˆ—å‡ºæ¯å€‹è¨‚è³¼äººçš„åˆ†å¸³æ˜ç´°
        for (const user in userStats) {
            const u = userStats[user];
            report += `ğŸ‘¤ ${user} - ç¸½é‡‘é¡ï¼šNT$ ${u.total}\n`;
            u.items.forEach(line => {
                report += `  ${line}\n`;
            });
            report += "---------------------------------\n";
        }
        
        report += "\n** ç¸½çµ **\n";
        
        // ç¸½è¨‚è³¼æ•¸ (ç½/çµ„)
        const totalQty = cart.reduce((sum, item) => sum + item.qty, 0);
        report += `ğŸ“¦ ç¸½è¨‚è³¼æ•¸ï¼š${totalQty} ä»½/çµ„\n`; 
        report += `ğŸ’° è¨‚å–®ç¸½é‡‘é¡ï¼šNT$ ${grandTotal}\n`;
        report += "---------------------------------\n";
        
        // 4. å½ˆå‡ºå®¢è£½åŒ–é€å‡ºè¦–çª—
        const container = document.getElementById('custom-modal-container');
        const content = document.getElementById('custom-modal-content');
        const titleEl = document.getElementById('modal-title');
        const messageEl = document.getElementById('modal-message');
        const modalFooter = document.getElementById('modal-footer');
        
        // è¨­ç½®æ¨™é¡Œå’Œå ±è¡¨å…§å®¹
        titleEl.innerText = "åœ˜è³¼è¨‚å–®å ±è¡¨ (é»é¸ä¸‹æ–¹é€å‡ºé¸é …)";
        messageEl.innerText = report;
        
        // éš±è—ä¸å¿…è¦çš„å…ƒç´ 
        document.getElementById('modal-input-group').classList.add('hidden');
        
        // æ¸…ç©ºä¸¦æ›¿æ› Modal Footer çš„å…§å®¹
        modalFooter.innerHTML = `
            <button onclick="hideCustomModal()" class="px-4 py-2 bg-stone-200 hover:bg-stone-300 text-stone-800 font-medium rounded-lg transition-colors">å–æ¶ˆ</button>
            <button onclick="sendToLine('${report.replace(/'/g, "\\'")}')" class="flex items-center gap-2 px-4 py-2 bg-green-500 hover:bg-green-600 text-white font-medium rounded-lg transition-colors">
                 <i data-lucide="message-square-text" class="w-4 h-4"></i> å‚³é€è‡³ Line
            </button>
            <button onclick="copyToClipboard('${report.replace(/'/g, "\\'")}')" class="flex items-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition-colors">
                 <i data-lucide="copy" class="w-4 h-4"></i> è¤‡è£½å ±è¡¨
            </button>
        `;
        lucide.createIcons(); // ç¢ºä¿æ–°åŠ å…¥çš„åœ–ç¤ºé¡¯ç¤º

        // é¡¯ç¤º Modal (ä½¿ç”¨æ›´å¤§çš„å¯¬åº¦)
        content.classList.remove('max-w-md');
        content.classList.add('max-w-xl', 'sm:max-w-2xl', 'lg:max-w-3xl'); // å¢åŠ å¯¬åº¦
        container.classList.remove('hidden');
        container.style.display = 'flex';
        setTimeout(() => {
            content.classList.remove('scale-90', 'opacity-0');
        }, 10);
    }

    // è¼”åŠ©å‡½æ•¸ï¼šæ²å‹•åˆ°ç”¢å“å€å¡Š
    function scrollToProducts() {
        document.getElementById('products').scrollIntoView({ behavior: 'smooth' });
    }


    // æ›´æ–° UIï¼šè¨‚è³¼æ˜ç´° Tab
    function updateCartUI() {
        const container = document.getElementById('cart-items-container');
        const totalElement = document.getElementById('cart-total');
        const badge = document.getElementById('cart-badge');
        const mobileBadge = document.getElementById('mobile-badge');
        const currentBuyerName = getCurrentBuyerName();
        const memberAlert = document.getElementById('member-mode-cart-alert');

        // æ ¹æ“šæ¨¡å¼ç¯©é¸è³¼ç‰©è»Š
        const filteredCart = isGroupLeader 
            ? cart 
            : cart.filter(item => item.userName === currentBuyerName);

        // é¡¯ç¤º/éš±è—åœ˜å“¡æ¨¡å¼æç¤º
        if (!isGroupLeader) {
            memberAlert.classList.remove('hidden');
            document.getElementById('current-buyer-name-display').innerText = currentBuyerName;
        } else {
            memberAlert.classList.add('hidden');
        }

        // è¨ˆç®—ç¸½é‡èˆ‡é‡‘é¡ (Filtered Cart)
        let totalQty = 0;
        let totalPrice = 0;

        if (filteredCart.length === 0) {
            container.innerHTML = `
                <div class="h-64 flex flex-col items-center justify-center text-stone-400 space-y-4">
                    <i data-lucide="shopping-cart" class="w-16 h-16 opacity-20"></i>
                    <p>${isGroupLeader ? 'è³¼ç‰©è»Šç›®å‰æ²’æœ‰è¨‚å–®' : `æ‚¨ (${currentBuyerName}) ç›®å‰æ²’æœ‰è¨‚å–®`}</p>
                    <p class="text-xs">è«‹åœ¨ä¸‹æ–¹è¼¸å…¥åå­—å¾Œé–‹å§‹é»é¤</p>
                </div>`;
            lucide.createIcons(); // ç¢ºä¿åœ–ç¤ºé¡¯ç¤º
        } else {
            // æŒ‰ç…§æœ€è¿‘åŠ å…¥æ’åº
            const sortedCart = [...filteredCart].sort((a, b) => b.timestamp - a.timestamp);
            
            let html = '';
            sortedCart.forEach(item => {
                const itemTotal = item.price * item.qty;
                totalPrice += itemTotal;
                
                // é¡¯ç¤ºæ™‚ç§»é™¤åç¨±ä¸­çš„å®¹é‡è³‡è¨Š (420g, 650g, 350g, 300g) å’Œçµ„è£è³‡è¨Š (*3, *4)
                const displayName = item.productName
                    .replace(/(\d+g)|(\(\d+g\))|(\*\d)/g, '')
                    .replace('ã€11æ¨‚ç¿»å¤©ã€‘', '')
                    .replace('ã€è¶…å€¼çµ„åˆã€‘', '')
                    .trim();

                html += `
                    <div class="flex gap-3 p-3 bg-white rounded-xl border border-stone-100 shadow-sm">
                        <img src="${item.image}" alt="${item.productName}" class="w-16 h-16 rounded-lg object-cover bg-stone-100">
                        <div class="flex-1 flex flex-col justify-between">
                            <div class="flex justify-between items-start">
                                <div>
                                    ${isGroupLeader ? 
                                        `<div class="flex items-center gap-2 mb-1">
                                            <span class="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full font-bold">${item.userName}</span>
                                            <h4 class="font-bold text-gray-900 text-sm line-clamp-1">${displayName}</h4>
                                        </div>`
                                        : 
                                        `<h4 class="font-bold text-gray-900 text-sm line-clamp-1">${displayName}</h4>`
                                    }
                                </div>
                                <button onclick="removeItem(${item.productId}, '${item.userName}')" class="text-stone-300 hover:text-red-500 p-1">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <div class="flex justify-between items-end">
                                <span class="text-sm font-bold text-red-600">NT$ ${itemTotal}</span>
                                <div class="flex items-center bg-stone-100 rounded-lg border border-stone-200 h-7 shadow-sm">
                                    <button onclick="changeQty(${item.productId}, '${item.userName}', -1)" class="px-2 h-full hover:bg-stone-200 text-stone-600 rounded-l-lg text-sm">-</button>
                                    <span class="px-2 text-xs font-bold min-w-[1.5rem] text-center">${item.qty}</span>
                                    <button onclick="changeQty(${item.productId}, '${item.userName}', 1)" class="px-2 h-full hover:bg-stone-200 text-stone-600 rounded-r-lg text-sm">+</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // æ›´æ–°ç¸½é‡‘é¡èˆ‡å¾½ç«  (å¾½ç« å’Œç¸½é‡‘é¡è¦é¡¯ç¤ºå…¨åœ˜çš„)
        const grandTotalPrice = cart.reduce((sum, item) => sum + item.price * item.qty, 0);
        const grandTotalQty = cart.reduce((sum, item) => sum + item.qty, 0);

        totalElement.innerText = `NT$ ${grandTotalPrice}`;
        badge.innerText = grandTotalQty;
        badge.classList.toggle('scale-0', grandTotalQty === 0);
        
        mobileBadge.innerText = grandTotalQty;
        mobileBadge.classList.toggle('hidden', grandTotalQty === 0);

        lucide.createIcons();
    }

    // æ›´æ–° UIï¼šçµ±è¨ˆ Tab
    function updateStatsUI() {
        const productList = document.getElementById('stats-product-list');
        const userList = document.getElementById('stats-user-list');
        const totalQtyEl = document.getElementById('stats-total-qty');
        const currentBuyerName = getCurrentBuyerName();
        const memberStatsAlert = document.getElementById('member-mode-stats-alert');


        if (cart.length === 0) {
            productList.innerHTML = '<p class="text-stone-400 text-center py-4">ç„¡è³‡æ–™</p>';
            userList.innerHTML = '<p class="text-stone-400 text-center py-4">ç„¡è³‡æ–™</p>';
            totalQtyEl.innerText = '0';
            memberStatsAlert.classList.add('hidden'); // ç„¡è³‡æ–™æ™‚éš±è—æç¤º
            return;
        }

        // 1. ä¾ç”¢å“çµ±è¨ˆ (çµ¦åº—å®¶) - æ°¸é ä½¿ç”¨æ•´å€‹ cart
        const productStats = {};
        let grandTotalQty = 0;
        
        cart.forEach(item => {
            // ç§»é™¤åç¨±ä¸­çš„å®¹é‡è³‡è¨Š (420g, 650g, 350g, 300g) å’Œçµ„è£è³‡è¨Š (*3, *4)
            const productName = item.productName
                .replace(/(\d+g)|(\(\d+g\))|(\*\d)/g, '')
                .replace('ã€11æ¨‚ç¿»å¤©ã€‘', '')
                .replace('ã€è¶…å€¼çµ„åˆã€‘', '')
                .trim();
            const productId = item.productId;

            if (!productStats[productId]) {
                productStats[productId] = { name: productName, qty: 0 };
            }
            productStats[productId].qty += item.qty;
            grandTotalQty += item.qty;
        });

        let productHtml = '';
        // ä¾ç…§ç”¢å“åç¨±æ’åº
        const sortedProductStats = Object.values(productStats).sort((a, b) => a.name.localeCompare(b.name, 'zh-TW'));

        sortedProductStats.forEach(p => {
            productHtml += `
                <div class="flex justify-between items-center border-b border-stone-100 last:border-0 py-2">
                    <span class="text-stone-700">${p.name}</span>
                    <span class="font-bold bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-md">x ${p.qty}</span>
                </div>
            `;
        });
        productList.innerHTML = productHtml;
        totalQtyEl.innerText = grandTotalQty;

        // 2. ä¾äººå“¡çµ±è¨ˆ (åˆ†å¸³)
        const userStats = {};
        
        // ç¯©é¸ cart: åœ˜ä¸»çœ‹å…¨éƒ¨ï¼Œåœ˜å“¡åªçœ‹è‡ªå·±
        const statsCart = isGroupLeader 
            ? cart 
            : cart.filter(item => item.userName === currentBuyerName);
            
        // é¡¯ç¤º/éš±è—åœ˜å“¡æ¨¡å¼æç¤º
        if (!isGroupLeader) {
            memberStatsAlert.classList.remove('hidden');
            document.getElementById('current-buyer-name-stats-display').innerText = currentBuyerName;
        } else {
            memberStatsAlert.classList.add('hidden');
        }

        statsCart.forEach(item => {
            if (!userStats[item.userName]) {
                userStats[item.userName] = { total: 0, items: [] };
            }
            
            const itemTotal = item.price * item.qty;
            userStats[item.userName].total += itemTotal;
            
            // åˆ†å¸³æ˜ç´°é¡¯ç¤ºç°¡æ½”åç¨±å’Œé‡‘é¡
            const displayName = item.productName
                .replace(/(\d+g)|(\(\d+g\))|(\*\d)/g, '')
                .replace('ã€11æ¨‚ç¿»å¤©ã€‘', '')
                .replace('ã€è¶…å€¼çµ„åˆã€‘', '')
                .trim();
            
            userStats[item.userName].items.push({
                name: displayName,
                qty: item.qty,
                price: item.price,
                total: itemTotal
            });
        });

        let userHtml = '';
        // ä¾ç…§ä½¿ç”¨è€…åç¨±æ’åº
        const sortedUserNames = Object.keys(userStats).sort((a, b) => a.localeCompare(b, 'zh-TW'));

        if (sortedUserNames.length === 0 && !isGroupLeader) {
             userList.innerHTML = '<p class="text-stone-400 text-center py-4">ç„¡æ‚¨åä¸‹çš„è¨‚å–®è³‡æ–™</p>';
        } else if (sortedUserNames.length === 0 && isGroupLeader) {
             userList.innerHTML = '<p class="text-stone-400 text-center py-4">ç„¡ä»»ä½•è¨‚å–®è³‡æ–™</p>';
        } else {
            sortedUserNames.forEach(user => {
                const u = userStats[user];
                // ä¾ç…§åƒ¹æ ¼é«˜ä½æ’åºæ˜ç´°
                const sortedItems = u.items.sort((a, b) => b.total - a.total);

                userHtml += `
                    <div class="border border-stone-200 rounded-xl p-4 bg-white shadow-md">
                        <div class="flex justify-between items-center pb-2 border-b border-stone-100">
                            <span class="font-bold text-lg text-stone-800 flex items-center gap-2">
                                <span class="w-2.5 h-2.5 rounded-full bg-red-600"></span>
                                ${user}
                            </span>
                            <span class="font-bold text-2xl text-red-600">NT$ ${u.total}</span>
                        </div>
                        <div class="text-sm text-stone-700 mt-3 space-y-2">
                            ${sortedItems.map(item => `
                                <div class="grid grid-cols-3 gap-2 text-xs sm:text-sm">
                                    <span class="truncate col-span-1">${item.name}</span>
                                    <span class="text-center font-medium text-stone-500">x ${item.qty}</span>
                                    <span class="text-right font-bold text-stone-800">NT$ ${item.total}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            );
            userList.innerHTML = userHtml;
        }
    }
    
    // ç¯©é¸ç”¢å“
    function filterProducts(filter, button) {
        // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„ active æ¨£å¼
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active', 'bg-stone-800', 'text-white');
            btn.classList.add('text-stone-500', 'hover:bg-stone-100');
        });
        // ç‚ºé»æ“Šçš„æŒ‰éˆ•æ·»åŠ  active æ¨£å¼
        button.classList.add('active', 'bg-stone-800', 'text-white');
        button.classList.remove('text-stone-500', 'hover:bg-stone-100');

        renderProducts(filter);
    }

    // æ¸²æŸ“ç”¢å“
    function renderProducts(filter = 'all') {
        const grid = document.getElementById('product-grid');
        grid.innerHTML = '';
        
        // æ ¹æ“š category ç¯©é¸ï¼Œå¦‚æœæ²’æœ‰ç‰¹åˆ¥åˆ†é¡ï¼Œé è¨­å…¨éƒ¨é¡¯ç¤º
        const filteredProducts = filter === 'all' 
            ? products 
            : products.filter(p => p.category === filter);

        // æ›´æ–°ç¯©é¸å™¨ä¸Šçš„ç¸½æ•¸
        const allBtn = document.querySelector('.filter-btn[onclick="filterProducts(\'all\', this)"]');
        if (allBtn) allBtn.innerText = `å…¨éƒ¨ (${products.length})`;
        
        // æ›´æ–°ç›®å‰ active ç¯©é¸å™¨çš„æ–‡å­—
        const activeBtn = document.querySelector('.filter-btn.active');
        if (activeBtn) activeBtn.innerText = `${activeBtn.innerText.split('(')[0].trim()} (${filteredProducts.length})`;

        // æ›´æ–°æ¨™é¡Œä¸Šçš„ç¸½æ•¸
        const h2Title = document.querySelector('h2');
        if (h2Title) h2Title.innerHTML = `åœ˜è³¼å…¨å“é …ä¸€è¦½ (${products.length}é …)<span class="absolute -bottom-2 left-0 w-1/2 h-1 bg-yellow-400 rounded-full"></span>`;


        filteredProducts.forEach(product => {
            const card = document.createElement('div');
            card.className = 'product-card bg-white rounded-2xl shadow-sm hover:shadow-xl transition-all duration-300 border border-stone-100 overflow-hidden flex flex-col group';
            
            // ç”¢ç”Ÿ 1-10 çš„é¸é …
            const options = Array.from({length: 10}, (_, i) => i + 1)
                .map(num => `<option value="${num}">${num}</option>`).join('');

            // ç§»é™¤åç¨±ä¸­çš„å®¹é‡è³‡è¨Š (420g, 650g, 350g, 300g) å’Œçµ„è£è³‡è¨Š (*3, *4)
            const cleanedName = product.name
                .replace(/(\d+g)|(\(\d+g\))|(\*\d)/g, '')
                .replace('ã€11æ¨‚ç¿»å¤©ã€‘', '')
                .replace('ã€è¶…å€¼çµ„åˆã€‘', '')
                .trim();

            card.innerHTML = `
                <div class="relative overflow-hidden aspect-[4/3] product-img-container bg-stone-100 flex items-center justify-center">
                    <img src="${product.image}" 
                         alt="${product.name}" 
                         class="w-full h-full object-cover"
                         onerror="this.onerror=null; this.parentElement.classList.remove('bg-stone-100'); this.parentElement.innerHTML='<div class=\\"p-8 text-center text-stone-400 text-sm\\"><i data-lucide=\\"image-off\\" class=\\"w-8 h-8 mx-auto mb-2\\"></i>åœ–ç‰‡è¼‰å…¥å¤±æ•—</div>'; lucide.createIcons();">
                    <div class="absolute top-3 left-3 bg-white/90 backdrop-blur text-xs font-bold px-3 py-1 rounded-full shadow-sm text-gray-800">${product.tag}</div>
                </div>
                <div class="p-6 flex flex-col flex-1">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-xl font-bold text-gray-900">${cleanedName}</h3>
                        <span class="text-lg font-bold text-red-600">NT$ ${product.price}</span>
                    </div>
                    <p class="text-sm text-gray-500 mb-4 flex-1 leading-relaxed">${product.desc}</p>
                    
                    <div class="mt-auto">
                        <div class="flex items-center gap-2 mb-3">
                            <label for="qty-${product.id}" class="text-sm font-bold text-stone-600">æ•¸é‡:</label>
                            <select id="qty-${product.id}" class="bg-stone-100 border border-stone-200 text-stone-900 text-sm rounded-lg focus:ring-yellow-500 focus:border-yellow-500 block w-full p-2.5 outline-none font-bold">
                                ${options}
                            </select>
                        </div>
                        <button onclick="addToCart(${product.id})" class="w-full py-3 bg-stone-800 hover:bg-yellow-500 hover:text-stone-900 text-white font-bold rounded-xl transition-all duration-300 flex items-center justify-center gap-2 shadow-md">
                            <i data-lucide="shopping-cart" class="w-4 h-4"></i> åŠ å…¥è³¼ç‰©è»Š
                        </button>
                    </div>
                </div>
            `;
            grid.appendChild(card);
        });
        lucide.createIcons();
    }
    
    // è³¼ç‰©è»Šå´é‚Šæ¬„åˆ‡æ›
    function toggleCart() {
        const drawer = document.getElementById('cart-drawer');
        const overlay = document.getElementById('cart-drawer-overlay');
        const isOpen = !drawer.classList.contains('translate-x-full');
        
        // ç¢ºä¿ UI æ›´æ–°
        if (!isOpen) { // æº–å‚™æ‰“é–‹
            updateCartUI(); // æ‰“é–‹å‰æ›´æ–°è¨‚è³¼æ˜ç´°
            updateStatsUI(); // æ‰“é–‹å‰æ›´æ–°çµ±è¨ˆå ±è¡¨
            overlay.classList.remove('hidden', 'opacity-0');
            drawer.classList.remove('translate-x-full');
            setTimeout(() => overlay.classList.remove('opacity-0'), 10);
        } else { // æº–å‚™é—œé–‰
            overlay.classList.add('opacity-0');
            drawer.classList.add('translate-x-full');
            setTimeout(() => overlay.classList.add('hidden'), 300);
        }
    }
    
    // è³¼ç‰©è»Š Tab åˆ‡æ›
    function switchTab(tabId) {
        // éš±è—æ‰€æœ‰å…§å®¹
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„ active æ¨£å¼
        document.querySelectorAll('[id^="tab-btn-"]').forEach(btn => {
            btn.classList.remove('text-red-600', 'border-red-600', 'bg-red-50', 'border-b-2');
            btn.classList.add('text-stone-500', 'hover:text-stone-800');
        });

        // é¡¯ç¤ºç›®æ¨™å…§å®¹
        document.getElementById(`tab-content-${tabId}`).classList.add('active');
        
        // è¨­ç½®ç›®æ¨™æŒ‰éˆ• active æ¨£å¼
        const targetBtn = document.getElementById(`tab-btn-${tabId}`);
        if (targetBtn) {
            targetBtn.classList.add('text-red-600', 'border-red-600', 'bg-red-50', 'border-b-2');
            targetBtn.classList.remove('text-stone-500', 'hover:text-stone-800');
        }

        // å¦‚æœåˆ‡æ›åˆ°çµ±è¨ˆï¼Œæ›´æ–°çµ±è¨ˆè³‡æ–™
        if (tabId === 'stats') {
            updateStatsUI();
        } else {
            updateCartUI();
        }
    }

    // åˆå§‹åŒ–
    window.onload = function() {
        loadData();
        renderProducts();
        // åˆå§‹åŒ–æ™‚é è¨­æ˜¯è¨‚è³¼æ˜ç´° tab
        updateCartUI(); 
        updateStatsUI(); 
    };
</script>
