```html
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å”ç™¼è¡Œæ³¡èœ | åœ˜è³¼çµ±è¨ˆç‰ˆ (å¤šäººå”ä½œ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons for aesthetic UI -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            padding-bottom: 80px; /* ç‚ºäº†åº•éƒ¨çš„è¨‚è³¼äººæµ®å‹•åˆ—é ç•™ç©ºé–“ */
        }

        /* è‡ªå®šç¾©æ²è»¸ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* è³¼ç‰©è»Šå‹•ç•« */
        .cart-panel { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .cart-overlay { transition: opacity 0.3s ease-in-out; }
        
        /* ç”¢å“åœ–ç‰‡æ‡¸åœæ•ˆæœ */
        .product-img-container img { transition: transform 0.5s ease; }
        .product-card:hover .product-img-container img { transform: scale(1.05); }

        /* Tab åˆ‡æ›å‹•ç•« */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .tab-content.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* é–å®šæŒ‰éˆ•æ¨£å¼ */
        .locked-button {
            cursor: not-allowed !important;
            opacity: 0.6 !important;
            background-color: #a1a1aa !important; /* Stone 400 */
            color: #d4d4d8 !important; /* Stone 300 */
            box-shadow: none !important;
        }
        
    </style>
</head>
<body class="bg-stone-50 text-stone-800 antialiased overflow-x-hidden">

    <!-- é ‚éƒ¨å°èˆª -->
    <nav class="fixed top-0 w-full bg-white/90 backdrop-blur-md shadow-sm z-40 transition-all duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <!-- Logo -->
                <div class="flex items-center gap-2 cursor-pointer" onclick="window.scrollTo(0,0)">
                    <div class="bg-red-700 text-white p-2 rounded-lg">
                        <span class="font-bold text-xl tracking-widest">å”</span>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-xl font-bold text-gray-900 tracking-wide">å”ç™¼è¡Œæ³¡èœ</span>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-yellow-600 font-medium tracking-wider">å¤šäººåœ˜è³¼å”ä½œç‰ˆ</span>
                            <!-- ç‹€æ…‹å¾½ç« ï¼šåˆå§‹é¡¯ç¤ºé€£ç·šä¸­ï¼Œé€£ç·šæˆåŠŸå¾Œé¡¯ç¤ºè¨‚è³¼ç‹€æ…‹ -->
                            <span id="order-status-badge" class="px-1.5 py-0.5 rounded text-[10px] bg-red-100 text-red-600 font-bold">é€£ç·šä¸­...</span>
                        </div>
                    </div>
                </div>

                <!-- å³å´æŒ‰éˆ• -->
                <div class="flex items-center gap-4">
                    <button id="cart-toggle" class="relative group p-2 hover:bg-stone-100 rounded-full transition-colors">
                        <i data-lucide="clipboard-list" class="w-6 h-6 text-stone-600 group-hover:text-red-700 transition-colors"></i>
                        <span id="cart-badge" class="absolute top-0 right-0 inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-red-600 rounded-full transform scale-0 transition-transform duration-200">0</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- è‹±é›„å€å¡Š (Hero) -->
    <header class="relative pt-32 pb-20 lg:pt-48 lg:pb-32 bg-stone-900 overflow-hidden">
        <div class="absolute inset-0 opacity-40">
            <!-- æ³¡èœèƒŒæ™¯åœ– (ä½¿ç”¨ Unsplash é€£çµ) -->
            <img src="https://images.unsplash.com/photo-1546069901-ba9599a7e63c?ixlib=rb-4.0.3&auto=format&fit=crop&w=2000&q=80" class="w-full h-full object-cover object-center" alt="[Image of Kimchi background]">
        </div>
        <div class="absolute inset-0 bg-gradient-to-t from-stone-900 via-stone-900/60 to-transparent"></div>
        
        <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <span class="inline-block py-1 px-3 rounded-full bg-yellow-500/20 text-yellow-400 text-sm font-semibold mb-6 border border-yellow-500/30 backdrop-blur-sm">
                å¤šäººç·šä¸Šå³æ™‚å”ä½œ
            </span>
            <h1 class="text-4xl sm:text-6xl font-bold text-white mb-6 leading-tight tracking-tight">
                åœ˜è³¼è¡¨å–®ï¼Œ<span class="text-yellow-400">å³æ™‚åŒæ­¥</span>
            </h1>
            <p class="text-lg sm:text-xl text-stone-300 mb-10 max-w-2xl mx-auto leading-relaxed" id="hero-message">
                é¸å¥½æ•¸é‡ï¼Œé»é¸ã€ŒåŠ å…¥æ¸…å–®ã€å³å¯å®Œæˆè¨‚è³¼ã€‚åœ˜å“¡åªçœ‹å¾—åˆ°è‡ªå·±çš„è¨‚å–®ã€‚
            </p>
            <div class="flex justify-center gap-4">
                <button onclick="document.getElementById('cart-toggle').click()" class="px-8 py-4 bg-yellow-500 hover:bg-yellow-400 text-stone-900 font-bold rounded-xl shadow-lg shadow-yellow-500/20 transition-all transform hover:-translate-y-1">
                    æŸ¥çœ‹æˆ‘çš„è¨‚å–®
                </button>
            </div>
        </div>
    </header>

    <!-- ç”¢å“å€å¡Š -->
    <main id="products" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-20">
        
        <!-- åˆ†é¡æ¨™ç±¤ -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-12">
            <h2 class="text-3xl font-bold text-gray-900 mb-6 md:mb-0 relative">
                å”ç™¼è¡Œå…¨å“é …
                <span class="absolute -bottom-2 left-0 w-1/2 h-1 bg-yellow-400 rounded-full"></span>
            </h2>
            
            <div class="flex space-x-2 bg-white p-1 rounded-lg shadow-sm border border-stone-200">
                <button class="filter-btn active px-4 py-2 rounded-md text-sm font-medium bg-stone-800 text-white transition-all" onclick="filterProducts('all', this)">å…¨éƒ¨</button>
                <button class="filter-btn px-4 py-2 rounded-md text-sm font-medium text-stone-500 hover:bg-stone-100 transition-all" onclick="filterProducts('spicy', this)">é¦™è¾£ç³»åˆ—</button>
                <button class="filter-btn px-4 py-2 rounded-md text-sm font-medium text-stone-500 hover:bg-stone-100 transition-all" onclick="filterProducts('non-spicy', this)">æ¸…çˆ½ä¸è¾£</button>
            </div>
        </div>

        <!-- ç”¢å“åˆ—è¡¨ç¶²æ ¼ -->
        <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- JS ç”Ÿæˆ -->
        </div>
    </main>

    <!-- åº•éƒ¨æ‡¸æµ®ï¼šç›®å‰è¨‚è³¼äººè¨­å®šèˆ‡åœ˜ä¸»æ¨¡å¼åˆ‡æ› -->
    <div class="fixed bottom-0 left-0 w-full bg-white border-t border-stone-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-30 px-4 py-3">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
            
            <!-- ä½¿ç”¨è€… ID è³‡è¨Šèˆ‡åç¨±è¼¸å…¥ (å·¦å´) -->
            <div class="flex items-center gap-3 text-xs text-stone-500 flex-wrap justify-center md:order-1">
                <div class="flex items-center gap-1">
                    <i data-lucide="shield-check" class="w-4 h-4 text-green-500"></i>
                    æ‚¨çš„ ID: <span id="current-user-id" class="font-mono font-bold text-stone-800 text-[10px] break-all">é€£ç·šä¸­...</span>
                </div>
                <div class="flex items-center gap-2 text-stone-600 whitespace-nowrap">
                    <i data-lucide="user-pen" class="w-5 h-5 text-red-600"></i>
                    <span class="font-bold hidden sm:inline">æ‚¨çš„åç¨±:</span>
                </div>
                <input type="text" id="current-buyer-input" value="æˆ‘è‡ªå·±" 
                    class="bg-stone-100 border-2 border-transparent focus:border-yellow-500 focus:bg-white rounded-lg px-3 py-1 text-center font-bold text-stone-800 outline-none transition-all w-24 sm:w-32 text-sm"
                    onfocus="this.select()">
            </div>
            
            <!-- åœ˜ä¸»æ¨¡å¼æŒ‰éˆ• (å³å´) -->
            <div class="md:order-3">
                <button onclick="checkOrganizerKey()" id="organizer-toggle-btn" class="px-4 py-2 bg-stone-800 hover:bg-stone-900 text-white font-bold rounded-lg transition-all text-sm shadow-md flex items-center gap-2">
                    <i data-lucide="lock" class="w-4 h-4" id="organizer-icon"></i>
                    <span id="organizer-text">åˆ‡æ›ç‚ºåœ˜ä¸»æ¨¡å¼ (é–å®š)</span>
                </button>
            </div>

            <!-- Mobile Cart Button -->
            <button onclick="document.getElementById('cart-toggle').click()" class="md:hidden relative p-2 bg-stone-100 rounded-full text-stone-600 md:order-2">
                <i data-lucide="clipboard-list" class="w-6 h-6"></i>
                <span id="mobile-badge" class="absolute -top-1 -right-1 w-4 h-4 bg-red-600 rounded-full text-[10px] text-white flex items-center justify-center hidden">0</span>
            </button>
        </div>
    </div>

    <!-- è³¼ç‰©è»Š/åœ˜è³¼çµ±è¨ˆ å´é‚Šæ¬„ -->
    <div id="cart-drawer-overlay" class="cart-overlay fixed inset-0 bg-black/50 z-50 hidden opacity-0" onclick="toggleCart()"></div>
    <div id="cart-drawer" class="cart-panel fixed top-0 right-0 h-full w-full sm:w-[480px] bg-white shadow-2xl z-50 transform translate-x-full flex flex-col">
        
        <!-- æ¨™é ­ -->
        <div class="p-5 border-b border-stone-100 flex justify-between items-center bg-white">
            <h2 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                <i data-lucide="clipboard-check" class="w-5 h-5 text-red-600"></i>
                <span id="cart-title">æˆ‘çš„è¨‚å–®æ¸…å–®</span>
            </h2>
            <button onclick="toggleCart()" class="p-2 hover:bg-stone-100 rounded-full transition-colors text-stone-500">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>

        <!-- Tab æŒ‰éˆ• -->
        <div class="flex border-b border-stone-200">
            <button onclick="switchTab('list')" id="tab-btn-list" class="flex-1 py-3 text-sm font-bold text-red-600 border-b-2 border-red-600 bg-red-50 transition-all">
                è¨‚è³¼æ˜ç´° (<span id="list-tab-status">æˆ‘çš„</span>)
            </button>
            <button onclick="switchTab('stats')" id="tab-btn-stats" class="flex-1 py-3 text-sm font-bold text-stone-500 hover:text-stone-800 transition-all">
                çµ±è¨ˆ/åˆ†å¸³
            </button>
        </div>

        <!-- å…§å®¹å€åŸŸ -->
        <div class="flex-1 overflow-hidden relative">
            
            <!-- Tab 1: è¨‚è³¼æ˜ç´° (ç¸½è¦½ - å¯æ“ä½œ) -->
            <div id="tab-content-list" class="tab-content active h-full overflow-y-auto p-5 space-y-4">
                <p id="loading-indicator" class="text-center text-stone-500 py-10 flex items-center justify-center gap-2">
                    <i data-lucide="loader-circle" class="w-4 h-4 animate-spin"></i>
                    è³‡æ–™é€£ç·šä¸­...
                </p>
                <!-- åœ˜ä¸»æ¨¡å¼æç¤º -->
                <div id="organizer-alert-list" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-3 rounded-md hidden mb-4 text-sm font-medium">
                    <p class="flex items-center gap-2"><i data-lucide="lock-open" class="w-4 h-4"></i> **åœ˜ä¸»æ¨¡å¼å·²å•Ÿç”¨:** æ‚¨æ­£åœ¨æŸ¥çœ‹æ‰€æœ‰åœ˜å“¡çš„è¨‚å–®æ˜ç´°ã€‚</p>
                </div>
                <!-- è¨‚å–®é–‹é—œæ§åˆ¶éˆ• (åƒ…åœ˜ä¸»å¯è¦‹) -->
                <div id="order-toggle-container" class="p-3 bg-white border border-stone-200 rounded-lg shadow-sm hidden">
                    <div class="flex items-center justify-between">
                        <span id="order-toggle-label" class="font-bold text-lg">è¨‚è³¼é–‹é—œç‹€æ…‹ï¼š<span class="text-green-600">é–‹å•Ÿ</span></span>
                        <button onclick="toggleOrderStatus()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition-colors text-sm shadow-md flex items-center gap-2">
                            <i data-lucide="power" class="w-4 h-4"></i>
                            <span id="order-toggle-button-text">é—œé–‰è¨‚è³¼</span>
                        </button>
                    </div>
                    <p class="text-xs text-stone-500 mt-1">æ§åˆ¶æ‰€æœ‰åœ˜å“¡æ˜¯å¦èƒ½å¤ æ–°å¢æˆ–ä¿®æ”¹è¨‚å–®ã€‚</p>
                </div>
                
                <div id="cart-items-container" class="space-y-4">
                    <!-- JS ç”Ÿæˆ -->
                </div>
            </div>

            <!-- Tab 2: çµ±è¨ˆå ±è¡¨ (å”¯è®€) -->
            <div id="tab-content-stats" class="tab-content h-full overflow-y-auto p-5 bg-stone-50">
                
                <!-- ç¸½é‡çµ±è¨ˆ (çµ¦åº—å®¶) -->
                <div class="bg-white p-4 rounded-xl shadow-sm mb-6">
                    <h3 class="font-bold text-lg text-stone-800 mb-3 flex items-center gap-2">
                        <i data-lucide="package" class="w-5 h-5 text-yellow-500"></i>
                        è¨‚è²¨ç¸½é‡çµ±è¨ˆ
                    </h3>
                    <div id="stats-product-list" class="space-y-2 text-sm">
                        <!-- JS ç”Ÿæˆ -->
                    </div>
                    <div class="mt-4 pt-3 border-t border-stone-100 flex justify-between items-center">
                        <span class="font-bold text-stone-600">ç¸½ç½æ•¸</span>
                        <span class="font-bold text-xl text-red-600" id="stats-total-qty">0</span>
                    </div>
                </div>

                <!-- åˆ†å¸³çµ±è¨ˆ (æ”¶éŒ¢ç”¨) -->
                <div class="bg-white p-4 rounded-xl shadow-sm">
                    <h3 class="font-bold text-lg text-stone-800 mb-3 flex items-center gap-2">
                        <i data-lucide="coins" class="w-5 h-5 text-yellow-500"></i>
                        äººå“¡åˆ†å¸³è¡¨
                    </h3>
                    <!-- åœ˜ä¸»æ¨¡å¼æç¤º -->
                    <div id="organizer-alert-stats" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-3 rounded-md hidden mb-4 text-sm font-medium">
                        <p class="flex items-center gap-2"><i data-lucide="lock-open" class="w-4 h-4"></i> **åœ˜ä¸»æ¨¡å¼å·²å•Ÿç”¨:** æ‚¨æ­£åœ¨æŸ¥çœ‹å®Œæ•´çš„åˆ†å¸³è³‡è¨Šã€‚</p>
                    </div>

                    <div id="stats-user-list-container" class="relative">
                        <!-- æ¨¡ç³Šé®ç½© (åœ˜å“¡æ¨¡å¼ä¸‹å•Ÿç”¨) -->
                        <div id="stats-user-list-mask" class="absolute inset-0 bg-stone-50/70 backdrop-blur-sm flex flex-col items-center justify-center p-4 rounded-xl space-y-3 z-10 hidden">
                            <i data-lucide="eye-off" class="w-8 h-8 text-stone-400"></i>
                            <p class="text-stone-600 font-bold text-center">åˆ†å¸³æ˜ç´°å·²éš±è—</p>
                            <p class="text-stone-500 text-sm text-center">æ­¤ç‚ºéš±ç§è¨­å®šï¼šåœ˜å“¡åªèƒ½æŸ¥çœ‹è‡ªå·±çš„ç¸½é‡‘é¡ã€‚<br>è«‹åˆ‡æ›è‡³ **åœ˜ä¸»æ¨¡å¼** ä»¥æŸ¥çœ‹å®Œæ•´åˆ—è¡¨ã€‚</p>
                            <button onclick="checkOrganizerKey()" class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-stone-900 font-bold rounded-lg transition-colors text-sm shadow-md">
                                æˆ‘æ˜¯åœ˜ä¸»ï¼Œè¼¸å…¥å¯†ç¢¼
                            </button>
                        </div>
                        <div id="stats-user-list" class="space-y-3 text-sm">
                            <!-- JS ç”Ÿæˆ -->
                        </div>
                        <div class="mt-4 pt-3 border-t border-stone-100 flex justify-between items-center">
                            <span class="font-bold text-stone-600">ç¸½é‡‘é¡</span>
                            <span class="font-bold text-xl text-red-600" id="stats-total-amount">NT$ 0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è¨Šæ¯æç¤ºè¦–çª— (å–ä»£ alert) -->
    <div id="message-box" class="fixed top-20 right-4 z-[9999] opacity-0 translate-x-10 transition-all duration-300 pointer-events-none">
        <div id="message-content" class="bg-red-500 text-white px-5 py-3 rounded-lg shadow-xl font-medium flex items-center gap-2">
            <!-- è¨Šæ¯å…§å®¹ -->
        </div>
    </div>


    <script type="module">
        // Firebase å¼•å…¥
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // ç¢ºä¿æ‰€æœ‰éœ€è¦çš„ Firestore å‡½æ•¸éƒ½è¢«å¼•å…¥ï¼ŒåŒ…æ‹¬ getDocs
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, writeBatch, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // ===================================================================
        // 1. å…¨åŸŸç‹€æ…‹èˆ‡ Firebase è¨­å®š
        // ===================================================================
        let app;
        let db;
        let auth;
        let userId = 'loading';
        let buyerName = 'æˆ‘è‡ªå·±';
        let isAuthReady = false; // é—œéµæ——æ¨™ï¼šç¢ºä¿ Firestore æ“ä½œå‰èªè­‰å·²å®Œæˆ
        let unsubscribeOrders = () => {};
        let unsubscribeOrderStatus = () => {};
        
        // å¤–éƒ¨æä¾›çš„ Canvas ç’°å¢ƒè®Šæ•¸
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // åœ˜è³¼ç‹€æ…‹
        let isOrganizer = localStorage.getItem('isOrganizer') === 'true'; // å¾ LocalStorage è¼‰å…¥åœ˜ä¸»ç‹€æ…‹
        let isOrderOpen = true; // é è¨­ç‚ºé–‹å•Ÿ
        const STATUS_DOC_PATH = `artifacts/${appId}/public/data/settings/orderStatus`;
        
        const PRODUCTS = [
            { id: 'classic-spicy', name: 'é»ƒé‡‘æ‹›ç‰Œæ³¡èœ', price: 160, category: 'spicy', img: 'https://placehold.co/400x300/f87171/ffffff?text=ç¶“å…¸æ³¡èœ' },
            { id: 'golden-nonspicy', name: 'é»ƒé‡‘è„†å£æµ·å¸¶çµ²', price: 180, category: 'non-spicy', img: 'https://placehold.co/400x300/4ade80/ffffff?text=è„†å£æµ·å¸¶çµ²' },
            { id: 'spicy-cabbage', name: 'éº»è¾£è‡­è±†è…', price: 220, category: 'spicy', img: 'https://placehold.co/400x300/fb923c/ffffff?text=éº»è¾£è‡­è±†è…' },
            { id: 'ginger-kimchi', name: 'éŸ“å¼é¦™è¾£è˜¿è””', price: 190, category: 'spicy', img: 'https://placehold.co/400x300/fca5a5/ffffff?text=é¦™è¾£è˜¿è””' },
            { id: 'sour-sweet', name: 'é…¸ç”œæŸšé¦™é»ƒç“œ', price: 170, category: 'non-spicy', img: 'https://placehold.co/400x300/86efac/ffffff?text=æŸšé¦™é»ƒç“œ' },
            { id: 'spicy-bamboo', name: 'éº»æ²¹è¾£ç­', price: 200, category: 'spicy', img: 'https://placehold.co/400x300/f97316/ffffff?text=éº»æ²¹è¾£ç­' },
        ];
        
        let userCart = {}; // å­˜æ”¾ç•¶å‰ä½¿ç”¨è€…çš„è¨‚å–® { productId: { ...orderData } }
        let allOrders = []; // å­˜æ”¾æ‰€æœ‰åœ˜å“¡çš„è¨‚å–® (åœ˜ä¸»æ¨¡å¼ä½¿ç”¨)

        // ===================================================================
        // 2. å·¥å…·å‡½å¼
        // ===================================================================
        
        /** é¡¯ç¤ºè‡ªå®šç¾©è¨Šæ¯ */
        function showMessage(text, isError = false) {
            const box = document.getElementById('message-box');
            const content = document.getElementById('message-content');
            
            box.classList.remove('opacity-0', 'translate-x-10', 'pointer-events-none');
            box.classList.add('opacity-100', 'translate-x-0', 'pointer-events-auto');
            
            content.className = `px-5 py-3 rounded-lg shadow-xl font-medium flex items-center gap-2`;
            if (isError) {
                content.classList.add('bg-red-600', 'text-white');
                content.innerHTML = `<i data-lucide="alert-triangle" class="w-5 h-5"></i><span>${text}</span>`;
            } else {
                content.classList.add('bg-green-600', 'text-white');
                content.innerHTML = `<i data-lucide="check-circle" class="w-5 h-5"></i><span>${text}</span>`;
            }
            lucide.createIcons(); // é‡æ–°æ¸²æŸ“ icon

            setTimeout(() => {
                box.classList.remove('opacity-100', 'translate-x-0', 'pointer-events-auto');
                box.classList.add('opacity-0', 'translate-x-10', 'pointer-events-none');
            }, 5000); // å»¶é•·é¡¯ç¤ºæ™‚é–“ï¼Œæ–¹ä¾¿æŸ¥çœ‹éŒ¯èª¤
        }

        /** å–å¾—ç”¢å“è³‡è¨Š */
        function getProduct(productId) {
            return PRODUCTS.find(p => p.id === productId);
        }

        /** æ›´æ–°ç”¢å“å¡ç‰‡ä¸Šçš„æ•¸é‡é¡¯ç¤º */
        function updateProductCardQty(productId, qty) {
            const qtyElement = document.getElementById(`qty-${productId}`);
            if (qtyElement) {
                qtyElement.textContent = qty;
            }
        }
        
        /** æ›´æ–°è³¼ç‰©è»Š/å´é‚Šæ¬„å¾½ç«  */
        function updateCartBadge() {
            const totalQty = Object.values(userCart).reduce((sum, item) => sum + item.quantity, 0);
            const badge = document.getElementById('cart-badge');
            const mobileBadge = document.getElementById('mobile-badge');
            
            badge.textContent = totalQty;
            mobileBadge.textContent = totalQty;

            if (totalQty > 0) {
                badge.classList.remove('scale-0');
                mobileBadge.classList.remove('hidden');
            } else {
                badge.classList.add('scale-0');
                mobileBadge.classList.add('hidden');
            }
        }

        // ===================================================================
        // 3. Firebase èªè­‰èˆ‡åˆå§‹åŒ–
        // ===================================================================

        /** åˆå§‹åŒ– Firebase */
        async function initFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase configuration is missing.");
                showMessage("Firebase é…ç½®éºå¤±ï¼Œè«‹æª¢æŸ¥ç’°å¢ƒè®Šæ•¸ã€‚", true);
                return;
            }
            
            setLogLevel('debug'); // é–‹å•Ÿ Firestore åµéŒ¯æ—¥èªŒ

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // å˜—è©¦ä½¿ç”¨è‡ªå®šç¾© token ç™»å…¥
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // å¦‚æœæ²’æœ‰ tokenï¼Œå‰‡åŒ¿åç™»å…¥
                    await signInAnonymously(auth);
                }
                
                // è¨­ç½®èªè­‰ç‹€æ…‹ç›£è½å™¨
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true; // èªè­‰å®Œæˆ
                        document.getElementById('current-user-id').textContent = userId;
                        
                        console.log("Firebase Auth Ready. User ID:", userId);
                        
                        // èªè­‰å®Œæˆå¾Œï¼Œé–‹å§‹ç›£è½è³‡æ–™
                        listenToOrderStatus();
                        listenToOrders(userId); // ç›£è½è‡ªå·±çš„è¨‚å–®
                        
                    } else {
                        console.log("User signed out or failed to sign in.");
                        isAuthReady = true; // å³ä½¿æ˜¯æœªèªè­‰ï¼Œä¹Ÿè¦–ç‚ºèªè­‰æµç¨‹å®Œæˆï¼Œä»¥ä¾¿é€²è¡ŒåŒ¿åæ“ä½œ
                        userId = 'unauthenticated';
                        document.getElementById('current-user-id').textContent = userId;
                    }
                    
                    document.getElementById('loading-indicator').classList.add('hidden');
                });

            } catch (error) {
                console.error("Firebase Initialization or Auth Error:", error);
                showMessage(`Firebase é€£ç·šå¤±æ•—: ${error.code}`, true);
            }
        }
        
        // ===================================================================
        // 4. Firestore ç›£è½èˆ‡è³‡æ–™è™•ç† (å¼·åŒ–éŒ¯èª¤æç¤º)
        // ===================================================================

        /** ç›£è½å…¨åŸŸè¨‚å–®é–‹é—œç‹€æ…‹ */
        function listenToOrderStatus() {
            // å–æ¶ˆèˆŠçš„ç›£è½
            unsubscribeOrderStatus(); 

            unsubscribeOrderStatus = onSnapshot(doc(db, STATUS_DOC_PATH), (docSnap) => {
                if (docSnap.exists()) {
                    const statusData = docSnap.data();
                    isOrderOpen = statusData.isOpen;
                } else {
                    // å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ (ç¬¬ä¸€æ¬¡é‹è¡Œ)ï¼Œå‰‡é è¨­é–‹å•Ÿä¸¦å¯«å…¥
                    isOrderOpen = true;
                    // ä½¿ç”¨ merge: true é¿å…è¦†è“‹å…¶ä»–å¯èƒ½çš„æ¬„ä½
                    setDoc(doc(db, STATUS_DOC_PATH), { isOpen: true, organizerId: userId }, { merge: true }).catch(err => {
                        console.error("Failed to set initial order status:", err);
                    });
                }
                // åœ¨é€™è£¡æ›´æ–° UIï¼Œè¡¨ç¤ºé€£ç·šæˆåŠŸ
                updateOrderStatusUI();
            }, (error) => {
                console.error("Error listening to order status. Check Security Rules for public/data:", error);
                let errorMessage = "ç„¡æ³•å³æ™‚å–å¾—è¨‚è³¼é–‹é—œç‹€æ…‹ã€‚";
                if (error.code === 'permission-denied') {
                    errorMessage = "ğŸš¨ è®€å–æ¬Šé™ä¸è¶³ (PERMISSION_DENIED)ã€‚è«‹è¯ç¹«åœ˜ä¸»æª¢æŸ¥ Firebase å®‰å…¨è¦å‰‡ã€‚";
                } else if (error.code) {
                    errorMessage += ` (éŒ¯èª¤ç¢¼: ${error.code})`;
                }
                showMessage(errorMessage, true);
                
                // å¦‚æœé€£ç·šå¤±æ•—ï¼Œå°‡ç‹€æ…‹æ¨™èªŒè¨­ç‚ºéŒ¯èª¤
                const statusBadge = document.getElementById('order-status-badge');
                statusBadge.textContent = 'é€£ç·šéŒ¯èª¤';
                statusBadge.className = 'px-1.5 py-0.5 rounded text-[10px] bg-red-600 text-white font-bold';
            });
        }
        
        /** ç›£è½ç•¶å‰ä½¿ç”¨è€…çš„è¨‚å–® */
        function listenToOrders(currentUserId) {
            // å–æ¶ˆèˆŠçš„ç›£è½
            unsubscribeOrders();
            
            // ç”±æ–¼ onAuthStateChanged å·²ç¶“è¨­å®šäº† isAuthReadyï¼Œé€™è£¡ä¸å†éœ€è¦é¡å¤–çš„æª¢æŸ¥
            const userOrdersCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/orders`);
            
            unsubscribeOrders = onSnapshot(userOrdersCollectionRef, (snapshot) => {
                userCart = {};
                snapshot.forEach((doc) => {
                    const order = doc.data();
                    // ç¢ºä¿è¨‚å–® ID è¢«æ”¾å…¥ order æ•¸æ“šä¸­
                    order.productId = doc.id; 
                    if (order.quantity > 0) {
                        userCart[doc.id] = order;
                    }
                });
                
                console.log("User Cart Updated:", userCart);
                
                // å¦‚æœç‹€æ…‹æ¨™èªŒé‚„åœ¨é€£ç·šä¸­ï¼Œåœ¨é€™è£¡æ›´æ–°ä¸€æ¬¡ç¢ºä¿é¡¯ç¤ºè¨‚å–®ç‹€æ…‹
                if (document.getElementById('order-status-badge').textContent === 'é€£ç·šä¸­...') {
                    updateOrderStatusUI();
                }

                renderProductCards(PRODUCTS); // æ›´æ–°å¡ç‰‡ä¸Šçš„æ•¸é‡
                renderCartList(userCart);     // æ›´æ–°è³¼ç‰©è»Šæ¸…å–®
                updateCartBadge();            // æ›´æ–°å¾½ç« 
                
                document.getElementById('loading-indicator').classList.add('hidden');
            }, (error) => {
                console.error("Error listening to user orders. Check Firebase Security Rules!", error);
                 // æª¢æŸ¥æ˜¯å¦ç‚ºæ¬Šé™å•é¡Œï¼Œä¸¦é¡¯ç¤ºæ˜ç¢ºæç¤º
                let errorMessage = "ç„¡æ³•å³æ™‚å–å¾—æ‚¨çš„è¨‚å–®è³‡æ–™ã€‚";
                if (error.code === 'permission-denied') {
                    errorMessage = "ğŸš¨ è®€å–æ¬Šé™ä¸è¶³ (PERMISSION_DENIED)ã€‚æ‚¨çš„è¨‚å–®ç„¡æ³•åŒæ­¥ã€‚";
                } else if (error.code) {
                    errorMessage += ` (éŒ¯èª¤ç¢¼: ${error.code})`;
                }
                showMessage(errorMessage, true);
            });
        }
        
        // ===================================================================
        // 5. å¯«å…¥/æ›´æ–°/åˆªé™¤æ“ä½œ (æ ¸å¿ƒä¿®æ­£èˆ‡åŠ å¼·éŒ¯èª¤æç¤º)
        // ===================================================================

        /** å„²å­˜æˆ–æ›´æ–°è¨‚å–®é …ç›® */
        async function saveOrder(productId, quantity) {
            // **ã€åŠ å¼·æª¢æŸ¥ã€‘ç¢ºä¿èªè­‰å’Œ userId å¯ç”¨**
            if (!isAuthReady || userId === 'loading' || userId === 'unauthenticated') {
                showMessage("ğŸš¨ èªè­‰å°šæœªæº–å‚™å¥½æˆ–ä½¿ç”¨è€…æœªç™»å…¥ï¼Œè«‹ç¨å€™å†è©¦ã€‚", true);
                console.error("Attempted to save order before Auth Ready. isAuthReady:", isAuthReady, "userId:", userId);
                return;
            }
            
            // **ã€é—œéµæª¢æŸ¥ã€‘è¨‚å–®ç‹€æ…‹æª¢æŸ¥**
            if (!isOrderOpen) {
                showMessage("ğŸš¨ è¨‚è³¼å·²æˆªæ­¢ï¼Œç„¡æ³•æ–°å¢æˆ–ä¿®æ”¹è¨‚å–®ã€‚", true);
                console.warn(`Attempted to save order when order is closed. Product: ${productId}`);
                return;
            }
            
            const productInfo = getProduct(productId);
            // ç¢ºä¿è·¯å¾‘æ­£ç¢ºï¼šartifacts/${appId}/users/${userId}/orders/{productId}
            const orderDocRef = doc(db, `artifacts/${appId}/users/${userId}/orders/${productId}`);
            const buyer = document.getElementById('current-buyer-input').value.trim() || 'åŒ¿ååœ˜å“¡';
            
            // å¦‚æœæ•¸é‡ç‚º 0ï¼Œå‰‡åŸ·è¡Œåˆªé™¤æ“ä½œ
            if (quantity === 0) {
                try {
                    await deleteDoc(orderDocRef);
                    showMessage(`å·²å¾æ¸…å–®ä¸­ç§»é™¤: ${productInfo.name}`);
                } catch (e) {
                    console.error("Error removing document:", e);
                    showMessage(`ç§»é™¤å¤±æ•—ã€‚éŒ¯èª¤ç¢¼: ${e.code || 'UNKNOWN'} (è«‹æª¢æŸ¥å®‰å…¨è¦å‰‡)`, true);
                }
                return;
            }
            
            // å¦å‰‡ï¼Œå„²å­˜æˆ–æ›´æ–°è¨‚å–®
            try {
                const orderData = {
                    name: productInfo.name,
                    price: productInfo.price,
                    quantity: quantity,
                    buyerName: buyer,
                    updatedAt: new Date().getTime(),
                    productId: productId, // ç¢ºä¿ productId å­˜å…¥ Document å…§
                };
                
                await setDoc(orderDocRef, orderData);
                showMessage(`æˆåŠŸåŠ å…¥æ¸…å–®: ${productInfo.name} x ${quantity} ç½`);
                
            } catch (e) {
                console.error("Error adding/updating document. Full error object:", e);
                // **ã€å¢å¼·éŒ¯èª¤æç¤ºã€‘** é¡¯ç¤ºéŒ¯èª¤ç¢¼ï¼Œå¹«åŠ©åˆ¤æ–·æ˜¯å¦ç‚ºæ¬Šé™å•é¡Œ
                showMessage(`è¨‚å–®å„²å­˜å¤±æ•—ã€‚éŒ¯èª¤ç¢¼: ${e.code || 'UNKNOWN'} (è«‹æª¢æŸ¥å®‰å…¨è¦å‰‡)`, true);
            }
        }
        
        /** åœ˜ä¸»åˆ‡æ›è¨‚å–®é–‹é—œ */
        async function toggleOrderStatus() {
            if (!isOrganizer) {
                showMessage("æ‚¨ä¸æ˜¯åœ˜ä¸»ï¼Œç„¡æ¬Šæ“ä½œæ­¤åŠŸèƒ½ã€‚", true);
                return;
            }
            
            const newStatus = !isOrderOpen;
            try {
                await setDoc(doc(db, STATUS_DOC_PATH), { isOpen: newStatus, organizerId: userId }, { merge: true });
                showMessage(`è¨‚è³¼å·²æˆåŠŸåˆ‡æ›è‡³: ${newStatus ? 'é–‹å•Ÿ' : 'é—œé–‰'}`);
            } catch (error) {
                console.error("Failed to toggle order status:", error);
                showMessage(`åˆ‡æ›é–‹é—œå¤±æ•—: ${error.message}`, true);
            }
        }

        // ===================================================================
        // 6. æ¸²æŸ“èˆ‡ UI äº’å‹•
        // ===================================================================

        /** æ¸²æŸ“ç”¢å“å¡ç‰‡ */
        function renderProductCards(products) {
            const container = document.getElementById('product-grid');
            container.innerHTML = products.map(p => {
                const currentQty = userCart[p.id] ? userCart[p.id].quantity : 0;
                
                // æª¢æŸ¥æ˜¯å¦é–å®š
                const isLocked = !isOrderOpen;
                const buttonClass = isLocked 
                    ? 'locked-button' 
                    : 'bg-red-600 hover:bg-red-700 active:bg-red-800 shadow-red-600/30';
                const buttonText = isLocked ? 'è¨‚è³¼å·²æˆªæ­¢' : 'åŠ å…¥æ¸…å–®';

                return `
                <div class="product-card bg-white rounded-2xl shadow-lg hover:shadow-xl transition-shadow overflow-hidden border border-stone-200 flex flex-col">
                    <!-- åœ–ç‰‡èˆ‡æ¨™ç±¤ -->
                    <div class="product-img-container relative h-48 overflow-hidden">
                        <img src="${p.img}" class="w-full h-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/400x300/e7e5e4/444444?text=${p.name.substring(0,2)}'" alt="${p.name} åœ–">
                        <span class="absolute top-3 right-3 px-3 py-1 bg-yellow-400 text-stone-900 text-sm font-bold rounded-full shadow-md">${p.category === 'spicy' ? 'é¦™è¾£' : 'æ¸…çˆ½'}</span>
                    </div>

                    <!-- å…§å®¹èˆ‡æ“ä½œ -->
                    <div class="p-6 flex flex-col flex-grow">
                        <h3 class="text-xl font-bold text-gray-900 mb-2">${p.name}</h3>
                        <div class="flex items-end justify-between mb-4 mt-auto">
                            <span class="text-3xl font-extrabold text-red-600">NT$ ${p.price}</span>
                            <span class="text-sm text-stone-500">/ ç½ (600g)</span>
                        </div>

                        <!-- æ•¸é‡æ§åˆ¶èˆ‡åŠ å…¥è³¼ç‰©è»Š -->
                        <div class="flex items-center justify-between gap-4">
                            <!-- æ•¸é‡é¸æ“‡ -->
                            <div class="flex items-stretch bg-stone-100 rounded-xl overflow-hidden shadow-inner w-2/5">
                                <button onclick="changeQty('${p.id}', -1)" class="w-10 h-10 flex items-center justify-center text-xl font-bold text-stone-600 hover:bg-stone-200 transition-colors rounded-l-xl" ${isLocked ? 'disabled' : ''}>
                                    ${currentQty > 0 ? '<i data-lucide="minus" class="w-4 h-4"></i>' : '<i data-lucide="trash-2" class="w-4 h-4"></i>'}
                                </button>
                                <span id="qty-${p.id}" class="flex-grow flex items-center justify-center text-lg font-bold text-stone-800">
                                    ${currentQty}
                                </span>
                                <button onclick="changeQty('${p.id}', 1)" class="w-10 h-10 flex items-center justify-center text-xl font-bold text-stone-600 hover:bg-stone-200 transition-colors rounded-r-xl" ${isLocked ? 'disabled' : ''}>
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                </button>
                            </div>
                            
                            <!-- åŠ å…¥æ¸…å–®æŒ‰éˆ• -->
                            <button id="add-btn-${p.id}" onclick="saveOrder('${p.id}', document.getElementById('qty-${p.id}').textContent * 1)" 
                                class="flex-grow px-4 py-2 text-white font-bold rounded-xl text-lg shadow-md transition-all transform hover:-translate-y-0.5 ${buttonClass}" ${isLocked ? 'disabled' : ''}>
                                ${buttonText}
                            </button>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
            lucide.createIcons(); // é‡æ–°æ¸²æŸ“ icon
        }

        /** è®Šæ›´å–®å€‹ç”¢å“çš„æ•¸é‡ (UI æš«æ™‚æ›´æ–°) */
        function changeQty(productId, delta) {
            if (!isOrderOpen) {
                showMessage("ğŸš¨ è¨‚è³¼å·²æˆªæ­¢ï¼Œç„¡æ³•èª¿æ•´æ•¸é‡ã€‚", true);
                return;
            }
            const qtyElement = document.getElementById(`qty-${productId}`);
            let currentQty = parseInt(qtyElement.textContent);
            let newQty = Math.max(0, currentQty + delta);

            qtyElement.textContent = newQty;
            
            // æ›´æ–° UI ä¸Šçš„åˆªé™¤/æ¸›è™Ÿåœ–ç¤º
            const minusButton = qtyElement.previousElementSibling;
            if (newQty === 0) {
                minusButton.innerHTML = lucide.createIcons({'trash-2': { class: 'w-4 h-4' }})['trash-2'];
            } else {
                minusButton.innerHTML = lucide.createIcons({'minus': { class: 'w-4 h-4' }})['minus'];
            }
            lucide.createIcons();
        }

        /** æ¸²æŸ“è³¼ç‰©è»Šæ¸…å–® */
        function renderCartList(cartData) {
            const container = document.getElementById('cart-items-container');
            const items = Object.values(cartData).sort((a, b) => b.updatedAt - a.updatedAt); // ä¾æœ€æ–°æ›´æ–°æ™‚é–“æ’åº
            
            if (isOrganizer) {
                // åœ˜ä¸»æ¨¡å¼ä¸‹ï¼Œé¡¯ç¤ºæ‰€æœ‰åœ˜å“¡çš„è¨‚å–®
                document.getElementById('cart-title').textContent = "åœ˜è³¼ç¸½è¡¨ (æ˜ç´°)";
                document.getElementById('list-tab-status').textContent = "æ‰€æœ‰è¨‚å–®";
                document.getElementById('organizer-alert-list').classList.remove('hidden');
                document.getElementById('order-toggle-container').classList.remove('hidden');
                
                // åœ˜ä¸»æ¨¡å¼ä¸‹çš„æ˜ç´°é ï¼Œä¸»è¦ä¾é  allOrders æ•¸æ“šï¼Œè©²æ•¸æ“šç”± fetchAllOrdersForStats å¡«å……
                
                if (allOrders.length === 0) {
                     container.innerHTML = `<p class="text-center text-stone-500 py-10">
                        <i data-lucide="info" class="w-4 h-4 inline-block mr-1"></i>
                        è«‹åˆ‡æ›åˆ° **çµ±è¨ˆ/åˆ†å¸³** é é¢æˆ–é‡æ–°æ‰“é–‹å´é‚Šæ¬„ï¼Œå°‡è‡ªå‹•è¼‰å…¥æ‰€æœ‰åœ˜å“¡çš„æœ€æ–°æ•¸æ“šã€‚
                        </p>`;
                    return;
                }
                
                // Group all orders by buyer
                const ordersByBuyer = allOrders.reduce((acc, order) => {
                    const buyerKey = order.buyerName || 'åŒ¿ååœ˜å“¡';
                    if (!acc[buyerKey]) {
                        acc[buyerKey] = {
                            total: 0,
                            items: []
                        };
                    }
                    const itemTotal = order.price * order.quantity;
                    acc[buyerKey].items.push(order);
                    acc[buyerKey].total += itemTotal;
                    return acc;
                }, {});
                
                container.innerHTML = Object.entries(ordersByBuyer).map(([buyer, data]) => {
                    return `
                    <div class="bg-stone-50 p-4 rounded-xl shadow-inner border border-stone-200">
                        <div class="flex justify-between items-center pb-2 border-b border-stone-200 mb-2">
                            <span class="font-bold text-red-600 text-lg flex items-center gap-2">
                                <i data-lucide="shopping-bag" class="w-5 h-5"></i>
                                ${buyer} çš„è¨‚å–® (${data.items.length} é …)
                            </span>
                            <span class="font-bold text-lg text-stone-800">NT$ ${data.total.toLocaleString()}</span>
                        </div>
                        ${data.items.map(item => `
                            <div class="flex justify-between text-sm py-1 border-b border-dashed border-stone-100 last:border-b-0">
                                <span class="text-stone-600">${item.name} x ${item.quantity}</span>
                                <span class="font-medium">NT$ ${(item.price * item.quantity).toLocaleString()}</span>
                            </div>
                        `).join('')}
                    </div>
                    `;
                }).join('');

            } else {
                // åœ˜å“¡æ¨¡å¼ä¸‹ï¼Œåªé¡¯ç¤ºè‡ªå·±çš„è¨‚å–®
                document.getElementById('cart-title').textContent = "æˆ‘çš„è¨‚å–®æ¸…å–®";
                document.getElementById('list-tab-status').textContent = "æˆ‘çš„";
                document.getElementById('organizer-alert-list').classList.add('hidden');
                document.getElementById('order-toggle-container').classList.add('hidden');

                if (items.length === 0) {
                    container.innerHTML = `<p class="text-center text-stone-500 py-10">æ‚¨çš„æ¸…å–®æ˜¯ç©ºçš„ï¼Œå¿«å»é¸è³¼å§ï¼</p>`;
                    return;
                }

                container.innerHTML = items.map(item => `
                    <div class="bg-white p-4 rounded-xl shadow-md border border-stone-100 flex items-center justify-between">
                        <!-- è¨‚å–®è³‡è¨Š -->
                        <div class="flex flex-col">
                            <span class="font-bold text-stone-800">${item.name}</span>
                            <span class="text-sm text-stone-500">NT$ ${item.price} x ${item.quantity} ç½</span>
                        </div>

                        <!-- åƒ¹æ ¼èˆ‡æ“ä½œ -->
                        <div class="flex items-center gap-4">
                            <span class="text-lg font-extrabold text-red-600">NT$ ${(item.price * item.quantity).toLocaleString()}</span>
                            <!-- åˆªé™¤æŒ‰éˆ• (è¨‚å–®é–‹æ”¾æ™‚æ‰å¯æ“ä½œ) -->
                            <button onclick="saveOrder('${item.productId}', 0)" 
                                class="p-2 rounded-full text-red-400 hover:bg-red-50 hover:text-red-600 transition-colors ${!isOrderOpen ? 'locked-button' : ''}" ${!isOrderOpen ? 'disabled' : ''}>
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            lucide.createIcons();
        }

        /** æ¸²æŸ“çµ±è¨ˆå ±è¡¨ (åƒ…åœ˜ä¸»æ¨¡å¼å¯è¦‹å®Œæ•´å…§å®¹) */
        async function renderStatistics() {
            if (isOrganizer) {
                 document.getElementById('organizer-alert-stats').classList.remove('hidden');
                 document.getElementById('stats-user-list-mask').classList.add('hidden');
                 // åœ˜ä¸»æ¨¡å¼ä¸‹ï¼ŒåŸ·è¡Œå…¨åŸŸè¨‚å–®ç²å–
                 await window.fetchAllOrdersForStats(); // é‡æ–°è¼‰å…¥æ‰€æœ‰è¨‚å–®
            } else {
                document.getElementById('organizer-alert-stats').classList.add('hidden');
                document.getElementById('stats-user-list-mask').classList.remove('hidden');
                // åœ˜å“¡æ¨¡å¼ä¸‹ï¼Œåªçµ±è¨ˆè‡ªå·±çš„è¨‚å–®
                // ç”±æ–¼ userCart å·²ç¶“æ˜¯æœ€æ–°çš„ï¼Œé€™è£¡ç›´æ¥ä½¿ç”¨
                allOrders = Object.values(userCart).map(item => ({ 
                    ...item, 
                    productId: item.productId, 
                    userId: userId, 
                    buyerName: item.buyerName || document.getElementById('current-buyer-input').value.trim() || 'åŒ¿ååœ˜å“¡'
                }));
            }
            
            // 1. ç”¢å“ç¸½é‡çµ±è¨ˆ
            const productStats = allOrders.reduce((acc, order) => {
                const product = getProduct(order.productId);
                if (!product) return acc; // é¿å…æ‰¾ä¸åˆ°ç”¢å“
                if (!acc[order.productId]) {
                    acc[order.productId] = { name: product.name, qty: 0 };
                }
                acc[order.productId].qty += order.quantity;
                return acc;
            }, {});

            const totalQty = Object.values(productStats).reduce((sum, p) => sum + p.qty, 0);
            document.getElementById('stats-total-qty').textContent = totalQty;
            
            const statsProductList = document.getElementById('stats-product-list');
            statsProductList.innerHTML = Object.values(productStats).sort((a, b) => b.qty - a.qty).map(p => `
                <div class="flex justify-between items-center py-1">
                    <span class="text-stone-600">${p.name}</span>
                    <span class="font-bold text-stone-800">${p.qty} ç½</span>
                </div>
            `).join('');


            // 2. äººå“¡åˆ†å¸³çµ±è¨ˆ (åªåœ¨åœ˜ä¸»æ¨¡å¼ä¸‹é¡¯ç¤ºæ‰€æœ‰ï¼Œåœ˜å“¡æ¨¡å¼åªé¡¯ç¤ºè‡ªå·±)
            const userStats = allOrders.reduce((acc, order) => {
                const buyerKey = order.buyerName || 'åŒ¿ååœ˜å“¡';
                if (!acc[buyerKey]) {
                    acc[buyerKey] = { 
                        buyerName: buyerKey, 
                        totalAmount: 0,
                        totalQty: 0,
                    };
                }
                acc[buyerKey].totalAmount += order.price * order.quantity;
                acc[buyerKey].totalQty += order.quantity;
                return acc;
            }, {});
            
            const totalAmount = Object.values(userStats).reduce((sum, u) => sum + u.totalAmount, 0);
            document.getElementById('stats-total-amount').textContent = `NT$ ${totalAmount.toLocaleString()}`;

            const statsUserList = document.getElementById('stats-user-list');
            
            let userListHtml = '';
            if (isOrganizer) {
                // åœ˜ä¸»æ¨¡å¼ï¼šé¡¯ç¤ºæ‰€æœ‰äºº
                userListHtml = Object.values(userStats).sort((a, b) => b.totalAmount - a.totalAmount).map(u => `
                    <div class="flex justify-between items-center py-2 border-b border-stone-100">
                        <span class="font-bold text-stone-800">${u.buyerName} (${u.totalQty} ç½)</span>
                        <span class="font-extrabold text-lg text-red-600">NT$ ${u.totalAmount.toLocaleString()}</span>
                    </div>
                `).join('');
            } else {
                // åœ˜å“¡æ¨¡å¼ï¼šåªé¡¯ç¤ºè‡ªå·±çš„ç¸½é‡‘é¡
                const currentBuyerName = document.getElementById('current-buyer-input').value.trim() || 'åŒ¿ååœ˜å“¡';
                const myStats = userStats[currentBuyerName] || { totalAmount: 0, totalQty: 0 };
                 userListHtml = `
                    <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                        <p class="font-bold text-yellow-800 mb-1">æ‚¨çš„è¨‚å–®ç¸½è¨ˆ</p>
                        <div class="flex justify-between items-center">
                            <span class="text-stone-600">ç¸½ç½æ•¸</span>
                            <span class="font-bold text-stone-800">${myStats.totalQty} ç½</span>
                        </div>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-stone-600">æ‡‰ä»˜é‡‘é¡</span>
                            <span class="font-extrabold text-xl text-red-600">NT$ ${myStats.totalAmount.toLocaleString()}</span>
                        </div>
                    </div>
                 `;
            }
            statsUserList.innerHTML = userListHtml;
            lucide.createIcons();
        }

        /** æ›´æ–°åœ˜è³¼é–‹é—œç›¸é—œçš„ UI */
        function updateOrderStatusUI() {
            const statusBadge = document.getElementById('order-status-badge');
            const toggleLabel = document.getElementById('order-toggle-label');
            const toggleButtonText = document.getElementById('order-toggle-button-text');
            const heroMessage = document.getElementById('hero-message');
            
            // 1. é ‚éƒ¨ç‹€æ…‹æ¨™ç±¤ (åƒ…åœ¨é€£ç·šæˆåŠŸå¾Œé¡¯ç¤º)
            statusBadge.textContent = isOrderOpen ? 'è¨‚è³¼é–‹å•Ÿä¸­' : 'è¨‚è³¼å·²æˆªæ­¢';
            statusBadge.classList.toggle('bg-red-100', !isOrderOpen);
            statusBadge.classList.toggle('text-red-600', !isOrderOpen);
            statusBadge.classList.toggle('bg-green-100', isOrderOpen);
            statusBadge.classList.toggle('text-green-600', isOrderOpen);
            statusBadge.classList.remove('bg-red-600', 'text-white'); // ç§»é™¤éŒ¯èª¤ç‹€æ…‹

            // 2. è‹±é›„å€å¡Šè¨Šæ¯
            heroMessage.textContent = isOrderOpen 
                ? 'é¸å¥½æ•¸é‡ï¼Œé»é¸ã€ŒåŠ å…¥æ¸…å–®ã€å³å¯å®Œæˆè¨‚è³¼ã€‚' 
                : 'ğŸš¨ åœ˜è³¼å·²æˆªæ­¢ï¼Œè«‹å‹¿å†æ–°å¢æˆ–ä¿®æ”¹è¨‚å–®ã€‚';

            // 3. åœ˜ä¸»æ§åˆ¶æŒ‰éˆ• (å´é‚Šæ¬„)
            if (isOrganizer) {
                toggleLabel.innerHTML = `è¨‚è³¼é–‹é—œç‹€æ…‹ï¼š<span class="${isOrderOpen ? 'text-green-600' : 'text-red-600'}">${isOrderOpen ? 'é–‹å•Ÿ' : 'é—œé–‰'}</span>`;
                toggleButtonText.textContent = isOrderOpen ? 'é—œé–‰è¨‚è³¼' : 'é–‹å•Ÿè¨‚è³¼';
            }
            
            // 4. ç”¢å“å¡ç‰‡æŒ‰éˆ•é–å®š (æ ¸å¿ƒåŠŸèƒ½)
            renderProductCards(PRODUCTS); // é‡æ–°æ¸²æŸ“ç”¢å“å¡ç‰‡ä»¥æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        }

        /** æª¢æŸ¥åœ˜ä¸»å¯†ç¢¼ */
        function checkOrganizerKey() {
            const correctKey = "kaiseki2024"; 
            
            if (isOrganizer) {
                // å¦‚æœå·²ç¶“æ˜¯åœ˜ä¸»ï¼Œåˆ‡æ›å›åœ˜å“¡æ¨¡å¼
                isOrganizer = false;
                localStorage.setItem('isOrganizer', 'false');
                showMessage("å·²åˆ‡æ›å›åœ˜å“¡æ¨¡å¼ã€‚");
            } else {
                // å˜—è©¦åˆ‡æ›ç‚ºåœ˜ä¸»
                const key = prompt("è«‹è¼¸å…¥åœ˜ä¸»å¯†ç¢¼ä»¥å•Ÿç”¨åœ˜è³¼ç¸½è¡¨åŠŸèƒ½ï¼š");
                if (key === correctKey) {
                    isOrganizer = true;
                    localStorage.setItem('isOrganizer', 'true');
                    showMessage("åœ˜ä¸»æ¨¡å¼å·²å•Ÿç”¨ï¼");
                    
                } else if (key !== null) {
                    showMessage("å¯†ç¢¼éŒ¯èª¤ï¼Œç„¡æ³•åˆ‡æ›ç‚ºåœ˜ä¸»ã€‚", true);
                } else {
                    return; // å–æ¶ˆ
                }
            }
            
            updateOrganizerUI();
            // å¼·åˆ¶åˆ·æ–° Tab å…§å®¹ï¼Œè®“åœ˜ä¸»æ¨¡å¼ä¸‹çš„æ•¸æ“šèƒ½æ­£ç¢ºè¼‰å…¥
            // æ¯æ¬¡åˆ‡æ›æ¨¡å¼ï¼Œéƒ½éœ€è¦é‡æ–°åŠ è¼‰ç•¶å‰ Tab æ•¸æ“š
            const currentTab = document.querySelector('.tab-content.active');
            if(currentTab) {
                switchTab(currentTab.id.replace('tab-content-', ''));
            } else {
                 switchTab('list'); // é è¨­åˆ‡å›æ˜ç´°é 
            }
        }

        /** æ›´æ–°åœ˜ä¸»ç›¸é—œ UI */
        function updateOrganizerUI() {
            const icon = document.getElementById('organizer-icon');
            const text = document.getElementById('organizer-text');
            const btn = document.getElementById('organizer-toggle-btn');
            
            if (isOrganizer) {
                icon.innerHTML = lucide.createIcons({'lock-open': { class: 'w-4 h-4' }})['lock-open'];
                text.textContent = "åˆ‡æ›å›åœ˜å“¡æ¨¡å¼";
                btn.classList.remove('bg-stone-800');
                btn.classList.add('bg-red-700', 'hover:bg-red-800');
            } else {
                icon.innerHTML = lucide.createIcons({'lock': { class: 'w-4 h-4' }})['lock'];
                text.textContent = "åˆ‡æ›ç‚ºåœ˜ä¸»æ¨¡å¼ (é–å®š)";
                btn.classList.add('bg-stone-800');
                btn.classList.remove('bg-red-700', 'hover:bg-red-800');
            }
            lucide.createIcons();
        }

        /** é–‹å•Ÿ/é—œé–‰è³¼ç‰©è»Šå´é‚Šæ¬„ */
        function toggleCart() {
            const drawer = document.getElementById('cart-drawer');
            const overlay = document.getElementById('cart-drawer-overlay');
            const isOpen = drawer.classList.contains('translate-x-full');

            if (isOpen) {
                drawer.classList.remove('translate-x-full');
                overlay.classList.remove('opacity-0', 'hidden');
                overlay.classList.add('opacity-100');
                // æ¯æ¬¡æ‰“é–‹å´é‚Šæ¬„ï¼Œç¢ºä¿çµ±è¨ˆæ•¸æ“šæ˜¯æœ€æ–°çš„
                const currentTab = document.querySelector('.tab-content.active');
                switchTab(currentTab ? currentTab.id.replace('tab-content-', '') : 'list');

            } else {
                drawer.classList.add('translate-x-full');
                overlay.classList.remove('opacity-100');
                setTimeout(() => {
                    overlay.classList.add('opacity-0', 'hidden');
                }, 300);
            }
        }
        
        /** åˆ‡æ› Tab */
        function switchTab(tabName) {
            const tabs = ['list', 'stats'];
            
            tabs.forEach(tab => {
                const content = document.getElementById(`tab-content-${tab}`);
                const button = document.getElementById(`tab-btn-${tab}`);
                
                if (tab === tabName) {
                    content.classList.add('active');
                    button.classList.add('text-red-600', 'border-red-600', 'bg-red-50');
                    button.classList.remove('text-stone-500', 'hover:text-stone-800', 'border-stone-200');
                    
                    if (isOrganizer) {
                        // åœ˜ä¸»æ¨¡å¼ä¸‹ï¼Œç„¡è«–åˆ‡æ›åˆ°å“ªå€‹ Tabï¼Œéƒ½éœ€è¦å…ˆè¼‰å…¥æ‰€æœ‰è¨‚å–®
                        window.fetchAllOrdersForStats().then(() => {
                            if (tabName === 'stats') {
                                renderStatistics(); 
                            } else {
                                renderCartList(userCart); // list tab render
                            }
                        });
                    } else {
                        // åœ˜å“¡æ¨¡å¼ä¸‹ï¼Œlist tab æ•¸æ“šä¾†è‡ª userCart (å·²ç›£è½)ï¼Œstats tab åªæ¸²æŸ“è‡ªå·±çš„
                        if (tabName === 'stats') {
                            renderStatistics(); 
                        } else {
                            renderCartList(userCart);
                        }
                    }
                } else {
                    content.classList.remove('active');
                    button.classList.remove('text-red-600', 'border-red-600', 'bg-red-50');
                    button.classList.add('text-stone-500', 'hover:text-stone-800', 'border-stone-200');
                }
            });
        }
        
        // ===================================================================
        // 7. å•Ÿå‹•ç¨‹åº
        // ===================================================================

        window.onload = function() {
            // å•Ÿå‹• Firebase
            initFirebase(); 
            
            // åˆå§‹æ¸²æŸ“
            renderProductCards(PRODUCTS);
            updateOrganizerUI();
            
            // è¨­å®šä½¿ç”¨è€…åç¨±è¼¸å…¥äº‹ä»¶
            document.getElementById('current-buyer-input').addEventListener('change', (e) => {
                buyerName = e.target.value.trim();
                localStorage.setItem('buyerName', buyerName);
                if (!isOrganizer) {
                    // å¦‚æœåœ˜å“¡æ›´æ”¹äº†åå­—ï¼Œä¹Ÿæ‡‰è©²æ›´æ–°å…¶æ‰€æœ‰è¨‚å–®ä¸Šçš„ buyerName æ¬„ä½
                    // é€™æ˜¯ä¸€å€‹æ‰¹é‡æ›´æ–°æ“ä½œï¼Œé˜²æ­¢èˆŠè¨‚å–®é‚„åœç•™åœ¨èˆŠåå­—
                    if (Object.keys(userCart).length > 0) {
                        const batch = writeBatch(db);
                        Object.keys(userCart).forEach(productId => {
                            const orderDocRef = doc(db, `artifacts/${appId}/users/${userId}/orders/${productId}`);
                            batch.update(orderDocRef, { buyerName: buyerName });
                        });
                        batch.commit().then(() => {
                            showMessage("è¨‚å–®ä¸Šçš„åœ˜è³¼åç¨±å·²åŒæ­¥æ›´æ–°ã€‚");
                        }).catch(error => {
                            console.error("Batch update failed:", error);
                            showMessage(`åç¨±åŒæ­¥å¤±æ•—ã€‚éŒ¯èª¤ç¢¼: ${error.code || 'UNKNOWN'}`, true);
                        });
                    }
                }
            });

            // å¾ LocalStorage è¼‰å…¥ä¸Šæ¬¡çš„åç¨±
            const savedName = localStorage.getItem('buyerName');
            if (savedName) {
                document.getElementById('current-buyer-input').value = savedName;
                buyerName = savedName;
            }
            
            // å°‡æ ¸å¿ƒå‡½æ•¸æš´éœ²åˆ°å…¨å±€ï¼Œä»¥ä¾¿ HTML å…§è¯äº‹ä»¶å¯ä»¥èª¿ç”¨
            window.toggleCart = toggleCart;
            window.switchTab = switchTab;
            window.filterProducts = (category, btn) => {
                // ... ç°¡å–®çš„éæ¿¾é‚è¼¯
                document.querySelectorAll('.filter-btn').forEach(b => {
                    b.classList.remove('bg-stone-800', 'text-white');
                    b.classList.add('text-stone-500', 'hover:bg-stone-100');
                });
                btn.classList.add('bg-stone-800', 'text-white');
                btn.classList.remove('text-stone-500', 'hover:bg-stone-100');
                
                const filtered = category === 'all' 
                    ? PRODUCTS 
                    : PRODUCTS.filter(p => p.category === category);
                renderProductCards(filtered);
            };
            window.changeQty = changeQty;
            window.saveOrder = saveOrder;
            window.checkOrganizerKey = checkOrganizerKey;
            window.toggleOrderStatus = toggleOrderStatus;
        };

        // åœ˜ä¸»æ¨¡å¼ä¸‹ï¼Œåªåœ¨åˆ‡æ›åˆ°çµ±è¨ˆé é¢æ™‚æ‰è¼‰å…¥æ‰€æœ‰è¨‚å–®
        window.fetchAllOrdersForStats = async function() {
            if (!db) return;
            allOrders = [];
            
            const statsUserList = document.getElementById('stats-user-list');
            const cartItemsContainer = document.getElementById('cart-items-container');
            
            // é¡¯ç¤ºè¼‰å…¥æŒ‡ç¤ºå™¨
            const targetContainer = document.getElementById('tab-content-stats').classList.contains('active') ? statsUserList : cartItemsContainer;
            targetContainer.innerHTML = `<p class="text-center text-stone-500 py-4"><i data-lucide="loader-circle" class="w-4 h-4 animate-spin inline-block mr-2"></i> æ­£åœ¨è¼‰å…¥æ‰€æœ‰åœ˜å“¡è¨‚å–®...</p>`;
            lucide.createIcons();

            const allUsersCollectionRef = collection(db, `artifacts/${appId}/users`);
            
            try {
                // 1. å–å¾—æ‰€æœ‰ç”¨æˆ¶çš„ ID (å³æ‰€æœ‰ /users/{userId} çš„æ–‡ä»¶)
                const userSnapshots = await getDocs(allUsersCollectionRef);
                
                // 2. é‡å°æ¯å€‹ç”¨æˆ¶ IDï¼Œå–å¾—ä»–å€‘çš„ /orders å­é›†åˆ
                const fetchPromises = userSnapshots.docs.map(userDoc => {
                    const currentUserId = userDoc.id;
                    const ordersCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/orders`);
                    
                    // æ³¨æ„ï¼šé€™è£¡ä½¿ç”¨ getDocs åŸ·è¡Œä¸€æ¬¡æ€§è®€å–ï¼Œè€Œé onSnapshot (å³æ™‚ç›£è½)
                    return getDocs(ordersCollectionRef).then(orderSnapshot => {
                        orderSnapshot.forEach(orderDoc => {
                            const order = orderDoc.data();
                            if (order.quantity > 0) {
                                allOrders.push({
                                    ...order,
                                    productId: orderDoc.id,
                                    userId: currentUserId,
                                });
                            }
                        });
                    });
                });
                
                await Promise.all(fetchPromises);
                
                // æˆåŠŸå¾Œï¼Œé‡æ–°æ¸²æŸ“ç•¶å‰æ‰“é–‹çš„ Tab
                const currentTabName = document.querySelector('.tab-content.active').id.replace('tab-content-', '');
                if(currentTabName === 'stats') {
                    renderStatistics(); 
                } else if (currentTabName === 'list') {
                    renderCartList(userCart); 
                }
                
            } catch (error) {
                console.error("Failed to fetch all orders for stats. Check Firebase Security Rules for /users/{userId}/orders read access:", error);
                
                let errorMessage = "åœ˜è³¼ç¸½è¡¨è¼‰å…¥å¤±æ•—ï¼Œç„¡æ³•è®€å–å…¶ä»–åœ˜å“¡è³‡æ–™ã€‚";
                if (error.code === 'permission-denied') {
                    errorMessage = "ğŸš¨ è®€å–æ¬Šé™ä¸è¶³ (PERMISSION_DENIED)ã€‚åœ˜ä¸»æ¨¡å¼ä¸‹çš„ç¸½è¡¨ç„¡æ³•åŒæ­¥ã€‚";
                } else if (error.code) {
                    errorMessage += ` (éŒ¯èª¤ç¢¼: ${error.code})`;
                }
                
                showMessage(errorMessage, true);
                
                // æ¸²æŸ“éŒ¯èª¤åˆ°å®¹å™¨
                targetContainer.innerHTML = `<p class="text-center text-red-600 py-4 font-bold">
                    <i data-lucide="alert-triangle" class="w-4 h-4 inline-block mr-2"></i>
                    ${errorMessage}
                </p>`;
            }
        }
        
    </script>
</body>
</html>
```